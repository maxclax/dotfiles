;;; +ui.el -*- mode: emacs-lisp; lexical-binding: t; -*-

;; Set fallback theme
(setq fancy-splash-image (concat doom-private-dir "assets/GNUEmacs.png"))

(use-package! circadian
              :config
              (setq circadian-themes '(("5:00" . doom-one-light)
                                       ("21:00" . doom-one)))

              ;; Determine the correct initial theme based on current time
              (let* ((hour-now (string-to-number (format-time-string "%H")))
                     (minute-now (string-to-number (format-time-string "%M")))
                     (time-now (+ (* hour-now 60) minute-now))
                     (light-start (+ (* 5 60) 0))   ;; 5:00 in minutes
                     (dark-start (+ (* 18 60) 30))) ;; 18:30 in minutes

                ;; Set the initial theme based on current time
                (setq doom-theme
                      (if (and (>= time-now light-start)
                               (< time-now dark-start))
                          'doom-one-light ;; During day (5:00-18:30)
                        'doom-one)))      ;; During night

              ;; Setup circadian for automatic switching
              (circadian-setup))

;; Perfect font + theme for emacsclient frames
(setq display-line-numbers-type t)
;; (setq display-line-numbers-type 'relative)
;; Perfect font + theme for emacsclient frames (2025 version)
(defun my/apply-gui-settings (&optional frame)
  "Apply font and current theme to FRAME (or current frame)."
  (when (display-graphic-p frame)
    (when (bound-and-true-p circadian--current-theme)
      (load-theme circadian--current-theme t))
    (set-face-attribute 'default nil
                        :font "Berkeley Mono Variable-18"
                        :weight 'normal)))

;; Apply on startup
(my/apply-gui-settings)

;; Apply to every new emacsclient frame
(add-hook 'after-make-frame-functions #'my/apply-gui-settings)


(setq-default fill-column 80
              delete-trailing-lines t)


(setq doom-modeline-height 30     ;; sets modeline height
      doom-modeline-bar-width 5   ;; sets right bar width
      doom-modeline-persp-name t  ;; adds perspective name to modeline
      doom-modeline-persp-icon t) ;; adds folder icon next to persp name

;; Every project must have own workspace
(setq +workspaces-on-switch-project-behavior t)

;; ── Session persistence ──────────────────────────────────────────────
;; persp-mode handles: buffers, window splits, workspaces
;; desktop.el handles: frame count + geometry (separate OS windows)
(setq persp-auto-resume-time 1)     ;; restore workspaces 1s after startup
(setq persp-auto-save-opt 1)        ;; auto-save on quit

;; desktop.el — only restores frame count/positions, not buffers or splits
(setq desktop-save t
      desktop-load-locked-desktop t
      desktop-auto-save-timeout 60
      desktop-restore-frames t
      desktop-restore-in-current-display nil
      desktop-restore-forces-onscreen nil
      desktop-files-not-to-save "."     ;; skip file buffers (persp handles)
      desktop-buffers-not-to-save "."   ;; skip all buffers (persp handles)
      desktop-globals-to-save nil)      ;; no variables

(add-hook 'doom-first-buffer-hook
          (lambda ()
            (desktop-save-mode 1)
            (run-with-timer 3 nil #'desktop-read)))

;; Dim inactive windows for visual focus feedback
(use-package! dimmer
  :config
  (setq-default dimmer-fraction 0.15)
  ;; Re-process all windows after theme changes
  (advice-add 'frame-set-background-mode :after (lambda (&rest _) (dimmer-process-all)))
  ;; Skip dimming in terminal frames — poor contrast with 256 colours
  (defun my/dimmer-exclude-terminal-p () (not (display-graphic-p)))
  (add-to-list 'dimmer-exclusion-predicates #'my/dimmer-exclude-terminal-p)
  (dimmer-mode 1))

;; Enable rainbow-mode globally
(use-package rainbow-mode
  :hook ((prog-mode text-mode conf-mode) . rainbow-mode))

;; Form feed line display (^L characters as horizontal lines)
(use-package! page-break-lines
  :config
  (global-page-break-lines-mode 1))

;; Display fill column indicator like Purcell
(when (boundp 'display-fill-column-indicator)
  (setq-default display-fill-column-indicator-character ?┊)
  (add-hook 'prog-mode-hook 'display-fill-column-indicator-mode))

;; Enable cursor blinking
(blink-cursor-mode 1)
(setq blink-cursor-interval 0.4
      blink-cursor-delay 0.5)

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;; LOG
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

(use-package! keycast
  :after doom-modeline
  :config
  ;; Show keycast via global-mode-string → doom-modeline misc-info segment
  ;; Works in all modelines without redefining each one
  (add-to-list 'global-mode-string '("" keycast-mode-line))
  (add-hook 'post-command-hook #'keycast--update))


;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;; COMPLETION
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

;; ── Corfu + childframe (your actual completion stack) ─────
;; (after! corfu
;;   (setq +corfu-want-ret-to-confirm "both")

;;   ;; Make childframe prettier + faster
;;   (setq corfu-popupinfo-delay '(0.5 . 0.5))  ; docs appear after 0.5s
;;   (corfu-popupinfo-mode 1))

;; (after! vertico-posframe
;;   (setq vertico-posframe-border-width 3
;;         vertico-posframe-poshandler #'posframe-poshandler-frame-bottom-center
;;         vertico-posframe-parameters '((left-fringe . 8)
;;                                       (right-fringe . 8))))

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;; PROSE MODE
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

(define-minor-mode prose-mode
  "Set up a buffer for prose editing.
Configures the buffer so that editing prose feels more like a
word processor — soft wraps, relaxed spacing, bar cursor, flyspell."
  :init-value nil :lighter " Prose" :keymap nil
  (if prose-mode
      (progn
        (when (fboundp 'writeroom-mode)
          (writeroom-mode 1))
        (setq truncate-lines nil)
        (setq word-wrap t)
        (setq cursor-type 'bar)
        (when (eq major-mode 'org-mode)
          (kill-local-variable 'buffer-face-mode-face))
        (buffer-face-mode 1)
        (setq-local blink-cursor-interval 0.6)
        (setq-local show-trailing-whitespace nil)
        (setq-local line-spacing 0.2)
        (setq-local electric-pair-mode nil)
        (ignore-errors (flyspell-mode 1))
        (visual-line-mode 1))
    (kill-local-variable 'truncate-lines)
    (kill-local-variable 'word-wrap)
    (kill-local-variable 'cursor-type)
    (kill-local-variable 'blink-cursor-interval)
    (kill-local-variable 'show-trailing-whitespace)
    (kill-local-variable 'line-spacing)
    (kill-local-variable 'electric-pair-mode)
    (buffer-face-mode -1)
    (flyspell-mode -1)
    (visual-line-mode -1)
    (when (fboundp 'writeroom-mode)
      (writeroom-mode 0))))

(custom-theme-set-faces! doom-theme
  `(hl-todo :foreground ,(doom-color 'bg)))
(after! hl-todo
  (setq hl-todo-color-background t
        hl-todo-keyword-faces
        `(("TODO"  . ,(doom-color 'orange))
          ("DONE"  . ,(doom-color 'green))
          ("NOTE"  . ,(doom-color 'green))
          ("DEBUG"  . ,(doom-color 'red))
          ("FAIL"  . ,(doom-color 'red))
          ("FIXME" . ,(doom-color 'red)))))
