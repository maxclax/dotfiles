;;; +text.el -*- mode: emacs-lisp; lexical-binding: t; -*-

(use-package! pomm
  :defer t
  :commands (pomm pomm-third-time)
  :config
  (setq pomm-work-period 30
        pomm-long-break-period 25
        pomm-short-break-period 5
        alert-default-style (if IS-MAC 'osx-notifier 'libnotify)
        pomm-audio-enabled t)
  (pomm-mode-line-mode))

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;; Org + PARA
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
  
(after! org
  ;; PARA for projects, tasks, files
  (setq org-directory (list {{ .primary_cloud | quote }} {{ .workspace | quote }} {{ .workspace_extra | quote }}))
  (setq org-agenda-file-regexp "\\`[^.].*\\.org\\'") ;; Exclude files starting with "."
  (setq org-agenda-files 
      (append (directory-files-recursively {{ .primary_cloud | quote }} "\\.org$")
              (directory-files-recursively {{ .workspace | quote }} "\\.org$")
              (directory-files-recursively {{ .workspace_extra | quote }} "\\.org$")))

  (setq org-default-notes-file (concat {{ .primary_cloud | quote }} "/0-Inbox/inbox.org"))
  (setq org-capture-templates
        '(("t" "Todo" entry (file+headline org-default-notes-file "Tasks")
           "* TODO %?\n  %i\n  %a")
          ("n" "Note" entry (file+headline org-default-notes-file "Notes")
           "* %?\n  %i\n  %a")
          ("p" "Project" entry (file (lambda () (concat {{ .primary_cloud | quote }} "/1-Projects/" (read-string "Project name: ") ".org")))
           "* TODO %?\n  %i\n  %a")
          ("a" "Area" entry (file (lambda () (concat {{ .primary_cloud | quote }} "/2-Areas/" (read-string "Area name: ") ".org")))
           "* %?\n  %i\n  %a")
          ("r" "Resource" entry (file (lambda () (concat {{ .primary_cloud | quote }} "/3-Resources/" (read-string "Resource name: ") ".org")))
           "* %?\n  %i\n  %a")))

  (setq org-log-repeat 'time)
  (setq org-todo-keywords
        '((sequence "TODO(t)" "NEXT(n)" "REPEAT(r)" "WAITING(w)" "|" "DONE(d)" "CANCELLED(c)")))

  (setq org-todo-keyword-faces
        '(("TODO" . (:foreground "#ff6c6b" :weight bold))
          ("NEXT" . (:foreground "#51afef" :weight bold))
          ("REPEAT" . (:foreground "#98be65" :weight bold))
          ("WAITING" . (:foreground "#ecbe7b" :weight bold))
          ("DONE" . (:foreground "#5B6268" :weight normal))
          ("CANCELLED" . (:foreground "#5B6268" :weight normal))))

  ;; Org agenda focus functions
  (defun org-focus-primary()
    "Set focus on primary cloud files."
    (interactive)
    (setq org-agenda-files
          (directory-files-recursively {{ .primary_cloud | quote }} "\\.org$")))

  (defun org-focus-workspace()
    "Set focus on workspace files."
    (interactive)
    (setq org-agenda-files
          (directory-files-recursively {{ .workspace | quote }} "\\.org$")))

  (defun org-focus-workspace-extra()
    "Set focus on extra workspace files."
    (interactive)
    (setq org-agenda-files
          (directory-files-recursively {{ .workspace_extra | quote }} "\\.org$")))

  (defun org-focus-all()
    "Set focus on all org files."
    (interactive)
    (setq org-agenda-files
          (append (directory-files-recursively {{ .primary_cloud | quote }} "\\.org$")
                  (directory-files-recursively {{ .workspace | quote }} "\\.org$")
                  (directory-files-recursively {{ .workspace_extra | quote }} "\\.org$"))))

  (defvar org-default-time "9:00"
    "The default time for deadlines.")

  ;; Startup settings
  (setq org-startup-folded 'content)
  (setq org-startup-indented t)
  (setq org-insert-heading-respect-content t)
  (setq org-blank-before-new-entry '((heading . nil)
                                     (plain-list-item . nil))))


(use-package! literate-calc-mode
  :hook (org-mode . literate-calc-minor-mode)
  :config
  (setq literate-calc-mode-inhibit-line-functions
        '(org-table-p org-src-block-p)))

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;; NEWSTICKER - RSS Feed Reader
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

;; Configure Newsticker immediately
(setq newsticker-url-list '(
  ("Emacs Rocks" "https://emacsrocks.com/atom.xml")
  ("Planet Emacslife" "https://planet.emacslife.com/atom.xml")
  ("Ruslan's Tech Blog" "https://codelearn.me/feed.xml")))

;; Custom function to close Newsticker buffers
(defun my/close-newsticker ()
  "Kill all tree-view related buffers."
  (ignore-errors
    (kill-buffer "*Newsticker List*"))
  (ignore-errors
    (kill-buffer "*Newsticker Item*"))
  (ignore-errors
    (kill-buffer "*Newsticker Tree*")))

(use-package! newsticker
  :defer t
  :config
  ;; Advice to automatically close buffers when quitting Newsticker
  (advice-add 'newsticker-treeview-quit :after 'my/close-newsticker))

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;; ELFEED - Alternative RSS Feed Reader
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

(use-package! elfeed
  :defer t
  :config
  ;; Feed configuration - same feeds as Newsticker for comparison
  (setq elfeed-feeds
        '("https://emacsrocks.com/atom.xml"
          "https://planet.emacslife.com/atom.xml"
          "https://www.reddit.com/r/emacs.rss"
          "https://www.reddit.com/r/orgmode.rss"
          "https://codelearn.me/feed.xml"))

  ;; Configure some useful settings
  (setq elfeed-db-directory (expand-file-name "elfeed" doom-cache-dir))
  (setq elfeed-search-filter "@1-week-ago +unread")
  (setq elfeed-use-curl t)
  (setq elfeed-curl-extra-arguments '("--insecure")))


  

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;; MARKDOWN
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

;; (setq markdown-fontify-code-blocks-natively t)

;; (remove-hook 'text-mode-hook #'auto-fill-mode)

;; (use-package! edit-indirect :defer t)

;; (add-hook! 'markdown-mode-hook (setq-local format-all-formatters '(("Markdown" prettier))))

;; (after! markdown-mode
;;   (advice-add #'markdown-follow-thing-at-point :around #'doom-set-jump-a))


;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;; OTHERS
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

(use-package! tldr
  :defer t
  :config
  (setq tldr-directory-path (concat doom-etc-dir "tldr/"))
  (set-popup-rule! "^\\*tldr\\*" :side 'right :select t :quit t)
  )

(use-package! link-hint :defer t)

(use-package! symbol-overlay :defer t)

(after! so-long
  (setq so-long-target-modes (delete 'text-mode so-long-target-modes)))

(use-package! adoc-mode
  :defer t
  :init
  (add-to-list 'auto-mode-alist (cons "\\.adoc\\'" 'adoc-mode)))
