;;; lisp/init-org.el -*- mode: emacs-lisp; lexical-binding: t; -*-

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;; Org + PARA
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

(after! org
  ;; Enable org-depend for sequential tasks
  (require 'org-depend)

  ;; Auto-save after state changes
  (advice-add 'org-agenda-todo :after
              (lambda (&rest _)
                (org-save-all-org-buffers)))

  ;; Reset checkboxes and subtasks when repeating task is marked DONE
  (defun my/reset-repeating-task ()
    "Reset checkboxes and subtasks in repeating tasks when marked DONE."
    (when (and (string= (org-get-todo-state) "DONE")
               (org-get-repeat))  ; Check if this is a repeating task
      (message "Resetting repeating task and subtasks...")
      (save-excursion
        (org-back-to-heading t)
        (let ((end (save-excursion (org-end-of-subtree t))))
          ;; Reset checkboxes
          (while (re-search-forward "^[ \t]*- \\[X\\]" end t)
            (replace-match "- [ ]" nil nil)
            (message "Reset checkbox"))
          ;; Reset subtasks back to TODO
          (goto-char (point))
          (org-map-entries
           (lambda ()
             (when (and (string= (org-get-todo-state) "DONE")
                        (> (org-current-level) 1))  ; Only subtasks
               (org-todo "TODO")
               (message "Reset subtask: %s" (org-get-heading t t))))
           nil 'tree)))))

  (add-hook 'org-after-todo-state-change-hook #'my/reset-repeating-task)

  ;; Dim blocked tasks
  (setq org-agenda-dim-blocked-tasks t)

  ;; Hide DONE tasks from agenda
  (setq org-agenda-skip-scheduled-if-done t
        org-agenda-skip-deadline-if-done t
        org-agenda-skip-timestamp-if-done t)

  ;; Show TODO subtasks as individual agenda items
  (setq org-agenda-todo-list-sublevels t)
  (setq org-tags-match-list-sublevels t)

  ;; Show subtasks of scheduled items in agenda
  (setq org-agenda-show-inherited-tags nil)
  (setq org-agenda-use-tag-inheritance nil)

  ;; Custom commands
  (setq org-agenda-custom-commands
        '(;; Default agenda (no DONE)
          ("a" "Agenda" agenda "") 

          ;; Show completed tasks
          ("c" "Completed tasks"
           ((tags "TODO=\"DONE\""
                  ((org-agenda-overriding-header "‚úÖ Completed Tasks")
                   (org-agenda-sorting-strategy '(timestamp-down)))))
           ((org-agenda-span 7)))  ; Last 7 days

          ;; GTD Full Review with Journal Integration
          ("d" "Dashboard (GTD)"
           ((agenda "" ((org-agenda-span 'day)
                       (org-agenda-overriding-header "üìÖ Today")
                       (org-agenda-todo-list-sublevels t)))
            (todo "TODO"
                  ((org-agenda-overriding-header "üèÜ Daily Outcomes & Journal Tasks")
                   (org-agenda-files (directory-files-recursively
                                     (expand-file-name "!org/denote/journal" {{ .primary_cloud | quote }}) "\\.org$"))
                   (org-agenda-sorting-strategy '(timestamp-down))
                   (org-agenda-max-entries 5)))
            (tags-todo "INBOX"
                  ((org-agenda-overriding-header "üì• Inbox - Process These")
                   (org-tags-match-list-sublevels nil)))
            (stuck ""
                   ((org-agenda-overriding-header "üö´ Stuck Projects (no NEXT)")
                    (org-agenda-tags-todo-honor-ignore-options t)
                    (org-tags-match-list-sublevels t)))
            (tags-todo "-INBOX/NEXT"
                       ((org-agenda-overriding-header "‚ö° Next Actions")
                        (org-agenda-skip-function
                         '(lambda ()
                            (org-agenda-skip-entry-if 'scheduled 'deadline)))
                        (org-tags-match-list-sublevels t)))
            (tags-todo "-INBOX/PROJECT"
                       ((org-agenda-overriding-header "üìÅ Active Projects")
                        (org-tags-match-list-sublevels t)))
            (tags-todo "-INBOX/-NEXT"
                       ((org-agenda-overriding-header "üîç Orphaned Tasks")
                        (org-agenda-skip-function
                         '(lambda ()
                            (or (org-agenda-skip-subtree-if 'todo '("PROJECT" "HOLD" "WAITING" "DELEGATED"))
                                (org-agenda-skip-subtree-if 'nottodo '("TODO"))
                                ;; Skip tasks with scheduled/deadline dates or repeating
                                (org-agenda-skip-entry-if 'scheduled 'deadline 'timestamp)
                                ;; Skip tasks with any tags
                                (when (org-get-tags-at) (point-max)))))
                        (org-tags-match-list-sublevels t)))
            (tags-todo "/WAITING"
                       ((org-agenda-overriding-header "‚è≥ Waiting For")))
            (tags-todo "/DELEGATED"
                       ((org-agenda-overriding-header "üë• Delegated")))
            (tags-todo "-INBOX/HOLD"
                       ((org-agenda-overriding-header "‚è∏Ô∏è On Hold")))))

          ;; Journal Dashboard
          ("j" "Journal Dashboard"
           ((agenda "" ((org-agenda-span 'day)
                       (org-agenda-overriding-header "üìÖ Today's Schedule")
                       (org-agenda-files (directory-files-recursively
                                         (expand-file-name "!org/denote/journal" {{ .primary_cloud | quote }}) "\\.org$"))))
            (todo "TODO"
                  ((org-agenda-overriding-header "üìù Journal Tasks & Outcomes")
                   (org-agenda-files (directory-files-recursively
                                     (expand-file-name "!org/denote/journal" {{ .primary_cloud | quote }}) "\\.org$"))
                   (org-agenda-sorting-strategy '(timestamp-down))))
            (tags "+journal"
                  ((org-agenda-overriding-header "üìî Recent Journal Entries")
                   (org-agenda-files (directory-files-recursively
                                     (expand-file-name "!org/denote/journal" {{ .primary_cloud | quote }}) "\\.org$"))
                   (org-agenda-sorting-strategy '(timestamp-down))
                   (org-agenda-max-entries 7)))))

          ;; Journal Review
          ("J" "Journal Review"
           ((tags "+journal"
                  ((org-agenda-overriding-header "üìñ All Journal Entries")
                   (org-agenda-files (directory-files-recursively
                                     (expand-file-name "!org/denote/journal" {{ .primary_cloud | quote }}) "\\.org$"))
                   (org-agenda-sorting-strategy '(timestamp-down))))
            (search ""
                    ((org-agenda-overriding-header "üîç Search Journal Content")
                     (org-agenda-files (directory-files-recursively
                                       (expand-file-name "!org/denote/journal" {{ .primary_cloud | quote }}) "\.org$"))))))

          ;; Review Dashboard
          ("R" "Review Dashboard"
           ((tags-todo "NEXT_REVIEW<=\"<today>\""
                  ((org-agenda-overriding-header "üìã Items Due for Review")
                   (org-agenda-sorting-strategy '(property-up))))
            (tags "REVIEW_PERIOD={.+}"
                  ((org-agenda-overriding-header "üìÖ All Review Items")
                   (org-agenda-sorting-strategy '(property-up))))))

          ;; GTD Focus View (inspired by EWS)
          ("g" "GTD Focus"
           ((agenda "" ((org-agenda-overriding-header "üìÖ Next 3 Days:")
                       (org-agenda-span 3)
                       (org-agenda-start-on-weekday nil)))
            (todo "NEXT" ((org-agenda-overriding-header "‚ö° Next Actions:")))
            (todo "WAITING" ((org-agenda-overriding-header "‚è≥ Waiting For:")))
            (todo "PROJECT" ((org-agenda-overriding-header "üìÅ Active Projects:")))))

          ;; Eisenhower Matrix (using priorities)
          ("E" "Eisenhower Matrix"
           ((tags-todo "PRIORITY=\"A\""
                       ((org-agenda-overriding-header "üî• DO (Priority A = I-U)")))
            (tags-todo "PRIORITY=\"B\""
                       ((org-agenda-overriding-header "üìÖ SCHEDULE (Priority B = I-NU)")))
            (tags-todo "PRIORITY=\"C\""
                       ((org-agenda-overriding-header "üë• DELEGATE (Priority C = NI-U)")))
            (tags-todo "PRIORITY=\"D\"|PRIORITY=\"\""
                       ((org-agenda-overriding-header "üóëÔ∏è DELETE (Priority D = NI-NU)")
                        (org-agenda-skip-function
                         '(lambda ()
                            (or (org-agenda-skip-entry-if 'scheduled 'deadline 'timestamp)
                                (org-agenda-skip-entry-if 'todo '("WAITING" "HOLD")))))))))))

  ;; Eisenhower Matrix agenda function
  (defun my/eisenhower-matrix-agenda ()
    "Show Eisenhower Matrix in agenda format."
    (interactive)
    (org-agenda nil "E"))

  ;; PARA for projects, tasks, files
  (setq org-directory (list {{ .primary_cloud | quote }} {{ .workspace | quote }} {{ .workspace_extra | quote }}))
  (setq org-agenda-file-regexp "\\`[^.].*\\.org\\'") ;; Exclude files starting with "."
  (setq org-agenda-files
        (seq-filter (lambda (file)
                      (not (string-match-p "/templates/" file)))
                    (append (directory-files-recursively {{ .primary_cloud | quote }} "\\.org$")
                            (directory-files-recursively {{ .workspace | quote }} "\\.org$")
                            (directory-files-recursively {{ .workspace_extra | quote }} "\\.org$")
                            ;; Include journal files in agenda
                            (directory-files-recursively (expand-file-name "!org/denote/journal" {{ .primary_cloud | quote }}) "\\.org$"))))

  (setq org-default-notes-file (concat {{ .primary_cloud | quote }} "/\!org/inbox.org"))
  (setq org-capture-templates
        '(;; Clean capture templates (no timestamps, links, or content)
          ("t" "INBOX: Todo (clean)" entry (file+headline org-default-notes-file "Tasks")
           "* TODO %?")
          ;; Full context capture templates
          ("c" "INBOX: Todo (full)" entry (file+headline org-default-notes-file "Tasks")
           "* TODO %?\n%U\n  %i\n  %a" :clock-resume t)
          ("P" "PROJECT: ROADMAP" entry (file (lambda ()
                                               (if (projectile-project-p)
                                                   (concat (projectile-project-root) "ROADMAP.org")
                                                 (error "Not in a projectile project"))))
           "* TODO %?\n%U\n  %i\n  %a")
          ;; Journal capture templates
          ("j" "Journal quick entry" entry (function my/journal-capture-target)
           "** %?\n%U\n  %i\n  %a" :clock-resume t)
          ("o" "Journal outcome" entry (function my/journal-capture-target)
           "- [ ] %?\n" :clock-resume t)
          ("r" "Journal reflection" entry (function my/journal-capture-target)
           "** Reflection\n%?\n%U\n" :clock-resume t)))

  ;; Helper function for journal capture
  (defun my/journal-capture-target ()
    "Return today's journal file or create it."
    (let* ((today (format-time-string "%Y%m%dT%H%M%S"))
           (title (format "Daily Log %s" (format-time-string "%Y-%m-%d")))
           (journal-dir (expand-file-name "!org/denote/journal" {{ .primary_cloud | quote }}))
           (today-file (car (directory-files journal-dir t (format-time-string "%Y-%m-%d")))))
      (or today-file
          (expand-file-name (format "%s--%s__journal.org"
                                   today
                                   (denote--slug-hyphenate title))
                           journal-dir))))

  (setq org-log-repeat 'time)
  ;; GTD-style TODO keywords with PROJECT state
  (setq org-todo-keywords
        '((sequence "TODO(t)" "NEXT(n)" "|" "DONE(d!/!)")
          (sequence "PROJECT(p)" "|" "DONE(d!/!)" "CANCELLED(c@/!)")
          (sequence "WAITING(w@/!)" "DELEGATED(D!)" "HOLD(h)" "|" "CANCELLED(c@/!)")))

  ;; Stuck projects detection (projects without NEXT actions)
  (setq org-stuck-projects '("-INBOX/PROJECT" ("NEXT")))

  ;; TODO keyword faces
  (setq org-todo-keyword-faces
        '(("NEXT" :inherit warning)
          ("PROJECT" :inherit font-lock-string-face)
          ("WAITING" :inherit font-lock-keyword-face)
          ("HOLD" :inherit font-lock-comment-face)))

  ;; Eisenhower Matrix priority system (A=I-U, B=I-NU, C=NI-U, D=NI-NU)
  (setq org-priority-highest ?A)
  (setq org-priority-lowest ?D)
  (setq org-priority-default ?D)

  ;; Priority faces for Eisenhower Matrix
  (setq org-priority-faces
        '((?A . (:foreground "red" :weight bold))      ; A = I-U (DO)
          (?B . (:foreground "orange" :weight bold))   ; B = I-NU (SCHEDULE)
          (?C . (:foreground "yellow" :weight bold))   ; C = NI-U (DELEGATE)
          (?D . (:foreground "gray" :weight normal))))

  ;; Enable habit tracking
  (require 'org-habit)
  (add-to-list 'org-modules 'org-habit)
  (setq org-habit-graph-column 14)
  (setq org-habit-show-habits-only-for-today t)

  ;; Calendar and scheduling configuration
  (setq calendar-week-start-day 1)                    ; Start calendar with Monday
  (setq org-agenda-start-on-weekday 1)               ; Start agenda week with Monday
  (setq org-read-date-prefer-future 'time)           ; Prefer future times when scheduling
  (setq org-read-date-force-compatible-dates nil)    ; Allow flexible date input
  (setq org-agenda-span 'week)                       ; Show week view by default
  (setq org-agenda-start-day nil)                    ; Start agenda with today
  (setq org-agenda-show-all-dates t)                 ; Show all days even if empty

  ;; Today navigation and highlighting
  (setq org-agenda-include-diary nil)                ; Don't include diary
  (setq org-agenda-skip-scheduled-if-deadline-is-shown t)  ; Avoid duplicate entries
  (setq org-deadline-warning-days 0)
  (setq org-scheduled-past-days 365)                     ; Show past scheduled items for 365 days
  (setq org-deadline-past-days 365)                      ; Show past deadline items for 365 days
  (setq org-scheduled-delay-days 365)                    ; Show overdue scheduled items for 365 days

  ;; Fast date selection
  (setq org-popup-calendar-for-date-selection t)     ; Show popup calendar for date selection

  ;; Universal clean display for all denote titles in agenda
  (defun my/clean-denote-title-for-agenda ()
    "Show clean denote titles for all agenda items with bold formatting."
    (when (buffer-file-name)
      (let* ((file (file-name-nondirectory (buffer-file-name)))
             (is-journal (string-match-p "journal" (buffer-file-name)))
             (is-outcome (save-excursion
                          (org-back-to-heading t)
                          (let ((outline-path (org-get-outline-path t)))
                            (cl-some (lambda (heading) (string-match-p "Daily Outcomes" heading)) outline-path)))))
        (cond
         ;; Denote journal files - extract date from filename
         (is-journal
          (let* ((title-part (if (string-match "^[0-9T]+--\\([^_]+\\)__" file)
                                 (match-string 1 file)
                                 (file-name-sans-extension file)))
                 (icon (if is-outcome "üèÜ" "üìù")))
            (format "%s *%s*: " icon title-part)))
         ;; Other denote files
         ((string-match "^[0-9T]+--\\([^_]+\\)__" file)
          (let ((clean-title (replace-regexp-in-string "-" " " (match-string 1 file))))
            (format "üìÑ *%s*: " (capitalize clean-title))))
         ;; Non-denote files - show just filename without extension
         (t
          (format "üìã *%s*: " (file-name-sans-extension file)))))))

  ;; Set prefix format for cleaner display across all agenda views
  (setq org-agenda-prefix-format
        '((agenda . " %i %(my/clean-denote-title-for-agenda)%?-12t% s")
          (todo . " %i %(my/clean-denote-title-for-agenda)")
          (tags . " %i %(my/clean-denote-title-for-agenda)")
          (search . " %i %(my/clean-denote-title-for-agenda)")))

  ;; Enable multiline agenda items to show full task content
  (setq org-agenda-tags-column -80)
  (setq org-agenda-window-setup 'current-window)
  (setq org-agenda-restore-windows-after-quit t)

  ;; Allow longer lines and wrap text
  (add-hook 'org-agenda-mode-hook
            (lambda ()
              (setq truncate-lines nil)
              (setq word-wrap t)))

  ;; Enhanced refiling system - include all available org directories
  (setq org-refile-targets
        `((nil :maxlevel . 5)
          (org-agenda-files :maxlevel . 5)
          (,(directory-files-recursively (expand-file-name "!org/denote" {{ .primary_cloud | quote }}) "\\.org$") :maxlevel . 5)
          ,@(when (file-exists-p {{ .workspace_extra | quote }})
              `((,(directory-files-recursively {{ .workspace_extra | quote }} "\\.org$") :maxlevel . 5)))))

  (setq org-refile-use-outline-path t)
  (setq org-outline-path-complete-in-steps nil)
  (setq org-refile-allow-creating-parent-nodes 'confirm)

  ;; Exclude DONE state tasks from refile targets
  (defun my/verify-refile-target ()
    "Exclude todo keywords with a done state from refile targets."
    (not (member (nth 2 (org-heading-components)) org-done-keywords)))
  (setq org-refile-target-verify-function 'my/verify-refile-target)

  ;; Auto-save after refile
  (advice-add 'org-refile :after (lambda (&rest _) (org-save-all-org-buffers)))

  ;; Clock tracking configuration
  (setq org-clock-persist t)
  (setq org-clock-in-resume t)
  (setq org-clock-into-drawer t)
  (setq org-log-into-drawer t)
  (setq org-clock-out-remove-zero-time-clocks t)

  ;; Disable logbook for subtasks by advising org-log functions
  (defun my/no-log-for-subtasks (orig-fun &rest args)
    "Don't log state changes for subtasks (level 3+)."
    (unless (and (org-at-heading-p)
                 (>= (org-current-level) 3))  ; Skip logging for level 3+ headings
      (apply orig-fun args)))

  (advice-add 'org-add-log-note :around #'my/no-log-for-subtasks)
  (setq org-time-clocksum-format
        '(:hours "%d" :require-hours t :minutes ":%02d" :require-minutes t))

  ;; Archive configuration - use dedicated archive directory
  (setq org-archive-location "archive/%s_archive::")
  (setq org-archive-save-context-info '(time file ltags itags todo category olpath))

  ;; Archive all DONE items in directory
  (defun org-archive-all-done-in-directory (directory)
    "Archive all DONE items in all org files in DIRECTORY."
    (interactive "DDirectory: ")
    (let ((org-files (directory-files-recursively directory "\\.org$")))
      (dolist (file org-files)
        (with-current-buffer (find-file-noselect file)
          (org-archive-all-done)
          (save-buffer)))))

  ;; Archive all DONE items in current org-agenda-files
  (defun org-archive-all-done-in-agenda-files ()
    "Archive all DONE items in all org-agenda-files."
    (interactive)
    (dolist (file org-agenda-files)
      (when (file-exists-p file)
        (with-current-buffer (find-file-noselect file)
          (org-archive-all-done)
          (save-buffer)))))

  ;; Weekly Outcomes Overview (for Friday Reflection reference)
  (defun my/weekly-outcomes-overview ()
    "Show weekly outcomes overview in side window for Friday reflection."
    (interactive)
    (let* ((today (current-time))
           (start-of-week (time-subtract today (seconds-to-time (* (calendar-day-of-week (calendar-current-date)) 86400))))
           (journal-files (directory-files-recursively
                          (expand-file-name "!org/denote/journal" {{ .primary_cloud | quote }}) "\\.org$"))
           (buffer-name "*Weekly Outcomes*"))

      ;; Create or switch to outcomes buffer
      (with-current-buffer (get-buffer-create buffer-name)
        (erase-buffer)
        (org-mode)

        ;; Insert header
        (insert "* Weekly Outcomes - " (format-time-string "%Y-%m-%d" start-of-week) "\n\n")

        ;; Process each journal file from this week
        (dolist (file journal-files)
          (when (file-readable-p file)
            (let ((file-date (file-attribute-modification-time (file-attributes file))))
              (when (time-less-p start-of-week file-date)
                (with-temp-buffer
                  (insert-file-contents file)
                  (goto-char (point-min))

                  ;; Extract date from filename
                  (let ((date-from-file (if (string-match "\\([0-9]\\{4\\}-[0-9]\\{2\\}-[0-9]\\{2\\}\\)" file)
                                           (match-string 1 file)
                                         "Unknown")))

                    ;; Find Daily Outcomes section
                    (when (re-search-forward "Daily Outcomes" nil t)
                      (with-current-buffer buffer-name
                        (insert "** " date-from-file "\n"))

                      ;; Extract outcomes
                      (let ((outcomes-found nil))
                        (while (re-search-forward "^\\*\\*\\* \\(TODO\\|DONE\\) \\(.+\\)$" nil t)
                          (let ((status (match-string 1))
                                (outcome (match-string 2)))
                            (setq outcomes-found t)
                            (with-current-buffer buffer-name
                              (insert (format "- [%s] %s\n"
                                            (if (string= status "DONE") "X" " ")
                                            outcome)))))

                        (unless outcomes-found
                          (with-current-buffer buffer-name
                            (insert "- No outcomes this day\n")))

                        (with-current-buffer buffer-name
                          (insert "\n")))))))))

        ;; Open in side window
        (display-buffer-in-side-window
         (current-buffer)
         '((side . right) (window-width . 80)))
        (message "Weekly outcomes overview opened. Use in parallel with your journal Friday reflection.")))))

  ;; Org agenda focus functions
  (defun org-focus-primary()
    "Set focus on primary cloud files."
    (interactive)
    (setq org-agenda-files
          (directory-files-recursively {{ .primary_cloud | quote }} "\\.org$")))

  (defun org-focus-workspace()
    "Set focus on workspace files."
    (interactive)
    (setq org-agenda-files
          (directory-files-recursively {{ .workspace | quote }} "\\.org$")))

  (defun org-focus-workspace-extra()
    "Set focus on extra workspace files."
    (interactive)
    (setq org-agenda-files
          (directory-files-recursively {{ .workspace_extra | quote }} "\\.org$")))

  (defun org-focus-all()
    "Set focus on all org files."
    (interactive)
    (setq org-agenda-files
          (append (directory-files-recursively {{ .primary_cloud | quote }} "\\.org$")
                  (directory-files-recursively {{ .workspace | quote }} "\\.org$")
                  (directory-files-recursively {{ .workspace_extra | quote }} "\\.org$"))))

  ;; Dynamic org-attach configuration based on file location
  (defun my/get-attach-dir ()
    "Get attachment directory based on current file location."
    (if (and (buffer-file-name)
             (string-match-p {{ .workspace_extra | quote }} (buffer-file-name)))
        ;; File is in extra workspace - use extra attach dir
        (expand-file-name "!org/.attach/" {{ .workspace_extra | quote }})
      ;; Default to primary attach dir
      (expand-file-name "!org/.attach/" {{ .primary_cloud | quote }})))

  (defun my/set-attach-dir ()
    "Set org-attach-id-dir based on current buffer location."
    (setq org-attach-id-dir (my/get-attach-dir))
    ;; Create attach directory if it doesn't exist
    (unless (file-exists-p org-attach-id-dir)
      (make-directory org-attach-id-dir t)))

  ;; Set initial attach directory
  (setq org-attach-id-dir (expand-file-name "!org/.attach/" {{ .primary_cloud | quote }}))
  (setq org-attach-dir-relative t)
  (setq org-attach-use-inheritance t)
  (setq org-attach-auto-tag "attach")
  (setq org-attach-store-link-p t)        ; Store link when attaching


  ;; Update attach directory when switching buffers
  (add-hook 'org-mode-hook #'my/set-attach-dir)
  (add-hook 'find-file-hook #'my/set-attach-dir)

  ;; Create primary attach directory if it doesn't exist
  (unless (file-exists-p org-attach-id-dir)
    (make-directory org-attach-id-dir t))

  ;; Function to choose file from disk and attach with link
  (defun my/org-attach-file-and-insert-link ()
    "Choose file from disk, attach it, and insert link automatically."
    (interactive)
    (let ((file (read-file-name "Choose file to attach: " nil nil t)))
      (when (and file (file-exists-p file))
        (my/org-attach-single-file file))))

  ;; Function to choose multiple files from disk and attach with links
  (defun my/org-attach-multiple-files-and-insert-links ()
    "Choose multiple files from disk using completion interface."
    (interactive)
    (let* ((directory (read-directory-name "Choose directory to select files from: "))
           (all-files (directory-files directory t "^[^.]"))  ; Exclude hidden files
           (file-names (mapcar (lambda (f)
                                (cons (file-name-nondirectory f) f))
                              all-files))
           (selected-files '()))

      ;; Use completing-read-multiple for multi-selection
      (let ((selected-names (completing-read-multiple
                            "Select files to attach (use TAB and separate with comma): "
                            file-names)))

        ;; Get full paths for selected files
        (dolist (name selected-names)
          (let ((full-path (cdr (assoc name file-names))))
            (when full-path
              (push full-path selected-files))))

        ;; Reverse to maintain selection order
        (setq selected-files (reverse selected-files))

        (if selected-files
            (progn
              ;; Ensure we have ID and attach tag (only once for all files)
              (unless (org-entry-get nil "ID")
                (org-id-get-create))
              (org-toggle-tag "attach" 'on)

              ;; Process each file
              (dolist (file selected-files)
                (my/org-attach-single-file file))
              (message "Attached %d files" (length selected-files)))
          (message "No files selected")))))

  ;; Helper function to attach a single file
  (defun my/org-attach-single-file (file)
    "Attach a single file and insert link."
    (when (and file (file-exists-p file))
      ;; Copy file to attachment directory
      (let* ((attach-dir (org-attach-dir-get-create))
             (filename (file-name-nondirectory file))
             (destination (expand-file-name filename attach-dir)))

        ;; Handle duplicate filenames
        (when (file-exists-p destination)
          (let ((base-name (file-name-sans-extension filename))
                (extension (file-name-extension filename t))
                (counter 1))
            (while (file-exists-p destination)
              (setq filename (format "%s-%d%s" base-name counter extension))
              (setq destination (expand-file-name filename attach-dir))
              (setq counter (1+ counter)))))

        ;; Copy the file
        (copy-file file destination)

        ;; Insert the link
        (insert (format "[[attachment:%s]]" filename))

        ;; For images, add display attributes and show inline
        (when (string-match-p "\\.(jpg\\|jpeg\\|png\\|gif\\|svg\\|bmp\\|webp)$" filename)
          (save-excursion
            (beginning-of-line)
            (insert "#+ATTR_ORG: :width 500\n")))

        ;; Add newline for next file
        (insert "\n")))

    ;; Show inline images after all files are processed
    (org-display-inline-images))

  ;; Configure native drag-and-drop to use 500 width for images
  (defun my/org-dnd-file-handler (uri action)
    "Handle drag-and-drop files with automatic attachment and width settings."
    (let ((file (dnd-get-local-file-name uri t)))
      (when (and file (file-exists-p file))
        ;; Ensure we have ID and attach tag
        (unless (org-entry-get nil "ID")
          (org-id-get-create))
        (org-toggle-tag "attach" 'on)

        ;; Use org-attach to handle the file
        (org-attach-attach file nil 'cp)

        ;; Insert the link with proper formatting
        (let ((filename (file-name-nondirectory file)))
          ;; For images, add display attributes
          (when (string-match-p "\\.(jpg\\|jpeg\\|png\\|gif\\|svg\\|bmp\\|webp)$" filename)
            (insert "#+ATTR_ORG: :width 500\n"))

          (insert (format "[[attachment:%s]]" filename))
          (insert "\n")

          ;; Display images inline
          (when (string-match-p "\\.(jpg\\|jpeg\\|png\\|gif\\|svg\\|bmp\\|webp)$" filename)
            (org-display-inline-images)))

        ;; Return 'private to indicate we handled the drop
        'private)))

  ;; Set the drag-and-drop handler for org-mode
  (add-hook 'org-mode-hook
            (lambda ()
              (setq-local dnd-protocol-alist
                          (cons '("^file:" . my/org-dnd-file-handler)
                                dnd-protocol-alist))))

  (defvar org-default-time "8:00"
    "The default time for deadlines.")

  ;; Simple automated review system
  (defun my/set-review-period (period)
    "Quickly set review period for current heading."
    (interactive
     (list (completing-read "Review period: "
                           '("daily" "weekly" "monthly" "quarterly"))))
    (org-set-property "REVIEW_PERIOD" period)
    (let ((days (pcase period
                  ("daily" 1)
                  ("weekly" 7)
                  ("monthly" 30)
                  ("quarterly" 90))))
      (org-set-property "NEXT_REVIEW"
                       (format-time-string "%Y-%m-%d"
                                         (time-add (current-time) (days-to-time days))))
      (message "Review set to %s" period)))

  (defun my/mark-reviewed ()
    "Mark current item as reviewed and calculate next review date."
    (interactive)
    (let ((period (org-entry-get nil "REVIEW_PERIOD")))
      (if period
          (let ((days (pcase period
                        ("daily" 1)
                        ("weekly" 7)
                        ("monthly" 30)
                        ("quarterly" 90))))
            (org-set-property "LAST_REVIEW" (format-time-string "%Y-%m-%d"))
            (org-set-property "NEXT_REVIEW"
                             (format-time-string "%Y-%m-%d"
                                               (time-add (current-time) (days-to-time days))))
            (message "Marked as reviewed. Next review: %s days" days))
        (message "No review period set. Use C-c r p first.")))))

(provide 'init-org)
