;;; lisp/init-org.el -*- mode: emacs-lisp; lexical-binding: t; -*-

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;; Org + PARA
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

(after! org
  ;; Syntax highlighting in src blocks
  (setq org-src-fontify-natively t)
  (setq org-src-tab-acts-natively t)

  ;; Enable org-depend for sequential tasks
  (require 'org-depend)

  ;; Auto-save after state changes
  (advice-add 'org-agenda-todo :after
              (lambda (&rest _)
                (org-save-all-org-buffers)))

  ;; Fix org-id initialization to prevent hash-table errors
  (with-eval-after-load 'org-id
    (unless org-id-locations
      (setq org-id-locations (make-hash-table :test 'equal)))
    (unless org-id-files
      (setq org-id-files nil)))

  ;; Force org-id initialization on startup
  (when (featurep 'org)
    (require 'org-id)
    (unless org-id-locations
      (setq org-id-locations (make-hash-table :test 'equal))))

  ;; Reset subtasks when repeating task is processed
  (defun my/reset-repeating-subtasks ()
    "Reset subtasks and checkboxes when a repeating task is reset."
    (when (org-get-repeat)              ; This is a repeating task
      (message "Resetting repeating task subtasks...")
      (save-excursion
        (org-back-to-heading t)
        (let ((end (save-excursion (org-end-of-subtree t))))
          ;; Reset all DONE subtasks back to TODO
          (org-map-entries
           (lambda ()
             (when (string= (org-get-todo-state) "DONE")
               (org-todo "TODO")
               (message "Reset subtask: %s" (org-get-heading t t))))
           nil 'tree)
          ;; Reset checkboxes (this should already work, but ensure it)
          (goto-char (point))
          (while (re-search-forward "^[ \t]*- \\[X\\]" end t)
            (replace-match "- [ ]" nil nil))))))

  ;; Use the proper hook that runs after repeat processing
  (add-hook 'org-todo-repeat-hook #'my/reset-repeating-subtasks)

  ;; org-agenda uses text properties for faces, not font-lock.
  ;; On first open after startup theme faces aren't fully resolved â€” redo once.
  (defvar my/org-agenda-initial-redo t)
  (add-hook 'org-agenda-mode-hook
            (lambda ()
              (when my/org-agenda-initial-redo
                (setq my/org-agenda-initial-redo nil)
                (run-with-idle-timer 0.3 nil #'org-agenda-redo))))

  ;; Dim blocked tasks
  (setq org-agenda-dim-blocked-tasks t)

  ;; Hide DONE tasks from agenda
  (setq org-agenda-skip-scheduled-if-done t
        org-agenda-skip-deadline-if-done t
        org-agenda-skip-timestamp-if-done t)

  ;; ;; Show TODO subtasks as individual agenda items
  ;; (setq org-agenda-todo-list-sublevels t)
  ;; (setq org-tags-match-list-sublevels t)

  ;; ;; Show subtasks of scheduled items in agenda
  ;; (setq org-agenda-show-inherited-tags nil)
  ;; (setq org-agenda-use-tag-inheritance nil)

  ;; Custom commands
  (setq org-agenda-custom-commands
        '(;; Default agenda (no DONE)

          ;; GTD Full Review with Journal Integration
          ("d" "Dashboard (GTD)"
           ((todo "TODO"
                  ((org-agenda-overriding-header (concat "ğŸ† Daily Outcomes â†’ " (my/get-today-date)))
                   (org-agenda-files (directory-files-recursively
                                      (expand-file-name "journal" {{ .org_dir | quote }}) "\\.org$"))
                   (org-agenda-sorting-strategy '(timestamp-down))
                   (org-agenda-max-entries 15)
                   (org-agenda-skip-function
                    '(lambda ()
                       (let ((outline-path (org-get-outline-path t)))
                         (or (when (member "someday" (org-get-tags))
                               (or (outline-next-heading) (point-max)))
                             (unless (cl-some (lambda (heading)
                                                (string-match-p "Daily Outcomes" heading))
                                              outline-path)
                               (or (outline-next-heading) (point-max)))))))))

            (agenda "" ((org-agenda-span 'day)
                        (org-agenda-overriding-header "ğŸ“… Today")
                        (org-agenda-todo-list-sublevels t)))

            (tags-todo "INBOX"
                       ((org-agenda-overriding-header "ğŸ“¥ Inbox - Process These")
                        (org-tags-match-list-sublevels nil)))

            (tags-todo "-INBOX-visit-hold/NEXT"
                       ((org-agenda-overriding-header "âš¡ Next Actions")
                        (org-agenda-skip-function
                         '(lambda ()
                            (org-agenda-skip-entry-if 'scheduled 'deadline)))
                        (org-tags-match-list-sublevels t)))
            (tags-todo "visit/NEXT"
                       ((org-agenda-overriding-header "ğŸ“ Places to Visit")
                        (org-tags-match-list-sublevels t)))
            (tags-todo "PRIORITY=\"A\""
                       ((org-agenda-overriding-header "ğŸ”¥ Important & Urgent (Priority A)")
                        (org-agenda-skip-function
                         '(lambda ()
                            (org-agenda-skip-entry-if 'todo '("WAITING" "HOLD"))))))

            (tags-todo "PRIORITY=\"B\""
                       ((org-agenda-overriding-header "ğŸ“… Important & Not Urgent (Priority B)")
                        (org-agenda-skip-function
                         '(lambda ()
                            (org-agenda-skip-entry-if 'todo '("WAITING" "HOLD"))))))

            (tags-todo "PRIORITY=\"C\""
                       ((org-agenda-overriding-header "ğŸ‘¥ Not Important & Urgent (Priority C)")
                        (org-agenda-skip-function
                         '(lambda ()
                            (org-agenda-skip-entry-if 'todo '("WAITING" "HOLD"))))))

            (tags-todo "project-INBOX-hold-someday-shopping"
                       ((org-agenda-overriding-header "ğŸš« Stuck Projects (no deadline/scheduled)")
                        (org-agenda-skip-function
                         '(lambda ()
                            (or (org-agenda-skip-entry-if 'scheduled 'deadline
                                                          'todo '("DONE" "CANCELLED" "HOLD" "NEXT" "WAITING"))
                                ;; Skip headings without a TODO keyword
                                (unless (org-get-todo-state)
                                  (or (outline-next-heading) (point-max))))))
                        (org-tags-match-list-sublevels t)))

            (tags-todo "/WAITING"
                       ((org-agenda-overriding-header "â³ Waiting For")
                        (org-agenda-skip-function
                         '(lambda ()
                            (let ((deadline (org-get-deadline-time (point)))
                                  (scheduled (org-get-scheduled-time (point)))
                                  (week-from-now (time-add (current-time) (days-to-time 3))))
                              (when (or deadline scheduled)
                                (unless (or (and deadline (time-less-p deadline week-from-now))
                                            (and scheduled (time-less-p scheduled week-from-now)))
                                  (or (outline-next-heading) (point-max))))
                              ;; If no deadline/schedule, always show (don't skip)
                              )))))

            (tags-todo "/DELEGATED"
                       ((org-agenda-overriding-header "ğŸ‘¥ Delegated")
                        (org-agenda-skip-function
                         '(lambda ()
                            (let ((deadline (org-get-deadline-time (point)))
                                  (scheduled (org-get-scheduled-time (point)))
                                  (week-from-now (time-add (current-time) (days-to-time 3))))
                              (when (or deadline scheduled)
                                (unless (or (and deadline (time-less-p deadline week-from-now))
                                            (and scheduled (time-less-p scheduled week-from-now)))
                                  (or (outline-next-heading) (point-max))))
                              ;; If no deadline/schedule, always show (don't skip)
                              )))))

            (tags-todo "-INBOX/-NEXT"
                       ((org-agenda-overriding-header "ğŸ” Orphaned Tasks")
                        (org-agenda-skip-function
                         '(lambda ()
                            (or (org-agenda-skip-subtree-if 'todo '("PROJECT" "HOLD" "WAITING" "DELEGATED"))
                                (org-agenda-skip-subtree-if 'nottodo '("TODO"))
                                ;; Skip tasks with scheduled/deadline dates or repeating
                                (org-agenda-skip-entry-if 'scheduled 'deadline 'timestamp)
                                ;; Skip tasks with local tags (ignore inherited filetags)
                                (when (org-get-tags nil t) (point-max))
                                ;; Skip any subtask (level 2+), only show top-level TODOs
                                (when (> (org-current-level) 1)
                                  (or (outline-next-heading) (point-max))))))
                        (org-tags-match-list-sublevels t)))

            (tags "project-INBOX-shopping"
                  ((org-agenda-overriding-header "ğŸ“ Active Projects")
                   (org-agenda-skip-function
                    '(lambda ()
                       ;; Show only the first level-1 heading per project file
                       (let ((first-heading
                              (save-excursion
                                (goto-char (point-min))
                                (when (re-search-forward "^\\* " nil t)
                                  (line-beginning-position)))))
                         (unless (and (= (org-current-level) 1)
                                      (= (line-beginning-position) first-heading))
                           (or (outline-next-heading) (point-max))))))
                   (org-tags-match-list-sublevels nil)))

            (tags "hold-INBOX"
                  ((org-agenda-overriding-header "â¸ï¸ On Hold Projects")
                   (org-agenda-skip-function
                    '(lambda ()
                       (let ((first-heading
                              (save-excursion
                                (goto-char (point-min))
                                (when (re-search-forward "^\\* " nil t)
                                  (line-beginning-position)))))
                         (unless (and (= (org-current-level) 1)
                                      (= (line-beginning-position) first-heading))
                           (or (outline-next-heading) (point-max))))))
                   (org-tags-match-list-sublevels nil)))

            (tags "research-INBOX"
                  ((org-agenda-overriding-header "ğŸ”¬ Research Ideas")
                   (org-agenda-skip-function
                    '(lambda ()
                       (let ((first-heading
                              (save-excursion
                                (goto-char (point-min))
                                (when (re-search-forward "^\\* " nil t)
                                  (line-beginning-position)))))
                         (unless (and (= (org-current-level) 1)
                                      (= (line-beginning-position) first-heading))
                           (or (outline-next-heading) (point-max))))))
                   (org-tags-match-list-sublevels nil)))

            (tags "pinned-INBOX"
                  ((org-agenda-overriding-header "ğŸ“Œ Pinned Notes")
                   (org-agenda-skip-function
                    '(lambda ()
                       (let ((first-heading
                              (save-excursion
                                (goto-char (point-min))
                                (when (re-search-forward "^\\* " nil t)
                                  (line-beginning-position)))))
                         (unless (and (= (org-current-level) 1)
                                      (= (line-beginning-position) first-heading))
                           (or (outline-next-heading) (point-max))))))
                   (org-tags-match-list-sublevels nil)))

            (tags-todo "-INBOX/HOLD"
                       ((org-agenda-overriding-header "â¸ï¸ On Hold")
                        (org-agenda-skip-function
                         '(lambda ()
                            (let ((deadline (org-get-deadline-time (point)))
                                  (scheduled (org-get-scheduled-time (point)))
                                  (week-from-now (time-add (current-time) (days-to-time 3))))
                              (when (or deadline scheduled)
                                (unless (or (and deadline (time-less-p deadline week-from-now))
                                            (and scheduled (time-less-p scheduled week-from-now)))
                                  (or (outline-next-heading) (point-max))))
                              )))))

            (tags "+someday/TODO"
                  ((org-agenda-overriding-header "â‰ï¸ Someday & Maybe")
                   (org-agenda-sorting-strategy '(priority-down alpha-up))
                   (org-agenda-remove-tags t)
                   (org-agenda-max-entries 10)
                   (org-agenda-prefix-format "  %i%(my/agenda-bold-prefix)%?-12t %s"))))
           ((org-agenda-finalize-hook '(my/agenda-apply-bold-prefix
                                        my/agenda-style-tags
                                        my/agenda-goto-top))))

          ;; Graveyard â€” RIP entries
          ("g" "Graveyard" agenda ""
           ((org-agenda-span 1)
            (org-agenda-files nil)
            (org-agenda-entry-types nil)
            (org-agenda-overriding-header "")
            (org-agenda-finalize-hook '(my/agenda-graveyard-full))))

          ;; Milestones â€” life counters
          ("m" "Milestones" agenda ""
           ((org-agenda-span 1)
            (org-agenda-files nil)
            (org-agenda-entry-types nil)
            (org-agenda-overriding-header "")
            (org-agenda-finalize-hook '(my/agenda-milestones-full))))

          ;; On This Day â€” single day view, navigate with [ / ] / 0
          ("o" "On This Day" agenda ""
           ((org-agenda-span 1)
            (org-agenda-files nil)
            (org-agenda-entry-types nil)
            (org-agenda-overriding-header "")
            (org-agenda-finalize-hook '((lambda () (setq my/otd-offset 0))
                                        my/agenda-on-this-day-full))))

          ;; Reading List â€” TODOs and INPROCESS items tagged :read:
          ("r" "Reading List"
           ((tags-todo "read+TODO=\"INPROCESS\""
                       ((org-agenda-overriding-header "ğŸ“– Reading Now")
                        (org-agenda-sorting-strategy '(priority-down alpha-up))
                        (org-agenda-prefix-format "  %i ")))
            (tags-todo "read+TODO=\"TODO\""
                       ((org-agenda-overriding-header "ğŸ“š To Read")
                        (org-agenda-sorting-strategy '(priority-down alpha-up))
                        (org-agenda-prefix-format "  %i "))))
           ((org-agenda-finalize-hook '(my/agenda-goto-top))))

          ;; GTD Full Review with Journal Integration
           ("D" "Dashboard (AR)"
          ((todo "TODO"
                 ((org-agenda-overriding-header (concat "ğŸ† Yearly Outcomes â†’ " (my/get-end-of-quarter-date)))
                  (org-agenda-files (directory-files-recursively
                                     (expand-file-name "journal" {{ .org_dir | quote }}) "\\.org$"))
                  (org-agenda-sorting-strategy '(deadline-up))
                  (org-agenda-max-entries 3)
                  (org-agenda-remove-tags t)
                  (org-agenda-skip-function
                   '(lambda ()
                      (let ((outline-path (org-get-outline-path t)))
                        (or (when (member "someday" (org-get-tags))
                              (or (outline-next-heading) (point-max)))
                            (unless (cl-some (lambda (heading)
                                               (string-match-p "Yearly Outcomes" heading))
                                             outline-path)
                              (or (outline-next-heading) (point-max)))))))))
           (todo "TODO"
                 ((org-agenda-overriding-header (concat "ğŸ† Monthly Outcomes â†’ " (my/get-end-of-month-date)))
                  (org-agenda-files (directory-files-recursively
                                     (expand-file-name "journal" {{ .org_dir | quote }}) "\\.org$"))
                  (org-agenda-sorting-strategy '(deadline-up))
                  (org-agenda-max-entries 5)
                  (org-agenda-remove-tags t)
                  (org-agenda-skip-function
                   '(lambda ()
                      (let ((outline-path (org-get-outline-path t)))
                        (or (when (member "someday" (org-get-tags))
                              (or (outline-next-heading) (point-max)))
                            (unless (cl-some (lambda (heading)
                                               (string-match-p "Monthly Outcomes" heading))
                                             outline-path)
                              (or (outline-next-heading) (point-max)))))))))
           (todo "TODO"
                 ((org-agenda-overriding-header (concat "ğŸ† Weekly Outcomes â†’ " (my/get-next-friday-date)))
                  (org-agenda-files (directory-files-recursively
                                     (expand-file-name "journal" {{ .org_dir | quote }}) "\\.org$"))
                  (org-agenda-sorting-strategy '(deadline-up))
                  (org-agenda-max-entries 10)
                  (org-agenda-remove-tags t)
                  (org-agenda-skip-function
                   '(lambda ()
                      (let ((outline-path (org-get-outline-path t)))
                        (or (when (member "someday" (org-get-tags))
                              (or (outline-next-heading) (point-max)))
                            (unless (cl-some (lambda (heading)
                                               (string-match-p "Weekly Outcomes" heading))
                                             outline-path)
                              (or (outline-next-heading) (point-max)))))))))
           (todo "TODO"
                 ((org-agenda-overriding-header "ğŸ† Daily Outcomes")
                  (org-agenda-files (directory-files-recursively
                                     (expand-file-name "journal" {{ .org_dir | quote }}) "\\.org$"))
                  (org-agenda-sorting-strategy '(timestamp-down))
                  (org-agenda-max-entries 15)
                  (org-agenda-remove-tags t)
                  (org-agenda-skip-function
                   '(lambda ()
                      (let ((outline-path (org-get-outline-path t)))
                        (or (when (member "someday" (org-get-tags))
                              (or (outline-next-heading) (point-max)))
                            (unless (cl-some (lambda (heading)
                                               (string-match-p "Daily Outcomes" heading))
                                             outline-path)
                              (or (outline-next-heading) (point-max)))))))))))


         ;; Friday Reflection - All Daily Outcomes Tasks
          ("F" "Friday Reflection - Daily Outcomes"
           (;; Weekly Outcomes TODOs from Monday (this week)
            (alltodo ""
                  ((org-agenda-overriding-header "ğŸ†ï¸ Weekly Outcomes")
                   (org-agenda-files (directory-files-recursively
                                       (expand-file-name "journal" {{ .org_dir | quote }}) "\\.org$"))
                   (org-agenda-skip-function
                    '(lambda ()
                       (let ((outline-path (org-get-outline-path t))
                             (current-heading (org-get-heading t t t t)))
                         ;; Show all items under Weekly Outcomes heading (including DONE)
                         (unless (or (string-match-p "ğŸ†ï¸ Weekly Outcomes\\|Weekly Outcomes" current-heading)
                                     (cl-some (lambda (heading)
                                               (string-match-p "ğŸ†ï¸ Weekly Outcomes\\|Weekly Outcomes" heading))
                                             outline-path))
                           (or (outline-next-heading) (point-max))))))
                   (org-agenda-show-inherited-tags nil)
                   (org-agenda-prefix-format "  %i%(my/agenda-bold-prefix)%?-12t %s")))
            (tags "LEVEL>0"
                  ((org-agenda-overriding-header "ğŸ“… Monday")
                   (org-agenda-files (directory-files-recursively
                                       (expand-file-name "journal" {{ .org_dir | quote }}) "\\.org$"))
                   (org-agenda-skip-function
                    '(lambda ()
                       (let* ((outline-path (org-get-outline-path t))
                              (file-date (file-name-base (buffer-file-name)))
                              (current-day (calendar-day-of-week (calendar-current-date)))
                              (days-since-monday (if (= current-day 0) 6 (1- current-day)))
                              (week-start (time-subtract (current-time) (seconds-to-time (* days-since-monday 86400))))
                              (monday-date (format-time-string "%Y%m%d" week-start)))
                         (unless (and (or (org-at-heading-p) (org-at-property-p))
                                       (cl-some (lambda (heading)
                                                (string-match-p "Daily Outcomes" heading))
                                              outline-path)
                                       (not (string-match-p "Daily Outcomes" (or (org-get-heading t t t t) "")))
                                       (string-match-p monday-date file-date))
                           (or (outline-next-heading) (point-max))))))
                   (org-agenda-show-inherited-tags nil)
                   (org-agenda-prefix-format "  %i%(my/agenda-bold-prefix)%?-12t %s")))
            (tags "LEVEL>0"
                  ((org-agenda-overriding-header "ğŸ“… Tuesday")
                   (org-agenda-files (directory-files-recursively
                                       (expand-file-name "journal" {{ .org_dir | quote }}) "\\.org$"))
                   (org-agenda-skip-function
                    '(lambda ()
                       (let* ((outline-path (org-get-outline-path t))
                              (file-date (file-name-base (buffer-file-name)))
                              (current-day (calendar-day-of-week (calendar-current-date)))
                              (days-since-monday (if (= current-day 0) 6 (1- current-day)))
                              (week-start (time-subtract (current-time) (seconds-to-time (* days-since-monday 86400))))
                              (tuesday-date (format-time-string "%Y%m%d" (time-add week-start (seconds-to-time 86400)))))
                         (unless (and (or (org-at-heading-p) (org-at-property-p))
                                       (cl-some (lambda (heading)
                                                (string-match-p "Daily Outcomes" heading))
                                              outline-path)
                                       (not (string-match-p "Daily Outcomes" (or (org-get-heading t t t t) "")))
                                       (string-match-p tuesday-date file-date))
                           (or (outline-next-heading) (point-max))))))
                   (org-agenda-show-inherited-tags nil)
                   (org-agenda-prefix-format "  %i%(my/agenda-bold-prefix)%?-12t %s")))
            (tags "LEVEL>0"
                  ((org-agenda-overriding-header "ğŸ“… Wednesday")
                   (org-agenda-files (directory-files-recursively
                                       (expand-file-name "journal" {{ .org_dir | quote }}) "\\.org$"))
                   (org-agenda-skip-function
                    '(lambda ()
                       (let* ((outline-path (org-get-outline-path t))
                              (file-date (file-name-base (buffer-file-name)))
                              (current-day (calendar-day-of-week (calendar-current-date)))
                              (days-since-monday (if (= current-day 0) 6 (1- current-day)))
                              (week-start (time-subtract (current-time) (seconds-to-time (* days-since-monday 86400))))
                              (wednesday-date (format-time-string "%Y%m%d" (time-add week-start (seconds-to-time (* 2 86400))))))
                         (unless (and (or (org-at-heading-p) (org-at-property-p))
                                       (cl-some (lambda (heading)
                                                (string-match-p "Daily Outcomes" heading))
                                              outline-path)
                                       (not (string-match-p "Daily Outcomes" (or (org-get-heading t t t t) "")))
                                       (string-match-p wednesday-date file-date))
                           (or (outline-next-heading) (point-max))))))
                   (org-agenda-show-inherited-tags nil)
                   (org-agenda-prefix-format "  %i%(my/agenda-bold-prefix)%?-12t %s")))
            (tags "LEVEL>0"
                  ((org-agenda-overriding-header "ğŸ“… Thursday")
                   (org-agenda-files (directory-files-recursively
                                       (expand-file-name "journal" {{ .org_dir | quote }}) "\\.org$"))
                   (org-agenda-skip-function
                    '(lambda ()
                       (let* ((outline-path (org-get-outline-path t))
                              (file-date (file-name-base (buffer-file-name)))
                              (current-day (calendar-day-of-week (calendar-current-date)))
                              (days-since-monday (if (= current-day 0) 6 (1- current-day)))
                              (week-start (time-subtract (current-time) (seconds-to-time (* days-since-monday 86400))))
                              (thursday-date (format-time-string "%Y%m%d" (time-add week-start (seconds-to-time (* 3 86400))))))
                         (unless (and (or (org-at-heading-p) (org-at-property-p))
                                       (cl-some (lambda (heading)
                                                (string-match-p "Daily Outcomes" heading))
                                              outline-path)
                                       (not (string-match-p "Daily Outcomes" (or (org-get-heading t t t t) "")))
                                       (string-match-p thursday-date file-date))
                           (or (outline-next-heading) (point-max))))))
                   (org-agenda-show-inherited-tags nil)
                   (org-agenda-prefix-format "  %i%(my/agenda-bold-prefix)%?-12t %s")))
            (tags "LEVEL>0"
                  ((org-agenda-overriding-header "ğŸ“… Friday")
                   (org-agenda-files (directory-files-recursively
                                       (expand-file-name "journal" {{ .org_dir | quote }}) "\\.org$"))
                   (org-agenda-skip-function
                    '(lambda ()
                       (let* ((outline-path (org-get-outline-path t))
                              (file-date (file-name-base (buffer-file-name)))
                              (current-day (calendar-day-of-week (calendar-current-date)))
                              (days-since-monday (if (= current-day 0) 6 (1- current-day)))
                              (week-start (time-subtract (current-time) (seconds-to-time (* days-since-monday 86400))))
                              (friday-date (format-time-string "%Y%m%d" (time-add week-start (seconds-to-time (* 4 86400))))))
                         (unless (and (or (org-at-heading-p) (org-at-property-p))
                                       (cl-some (lambda (heading)
                                                (string-match-p "Daily Outcomes" heading))
                                              outline-path)
                                       (not (string-match-p "Daily Outcomes" (or (org-get-heading t t t t) "")))
                                       (string-match-p friday-date file-date))
                           (or (outline-next-heading) (point-max))))))
                   (org-agenda-show-inherited-tags nil)
                   (org-agenda-prefix-format "  %i%(my/agenda-bold-prefix)%?-12t %s")))
            (tags "LEVEL>0"
                  ((org-agenda-overriding-header "ğŸ“… Saturday")
                   (org-agenda-files (directory-files-recursively
                                       (expand-file-name "journal" {{ .org_dir | quote }}) "\\.org$"))
                   (org-agenda-skip-function
                    '(lambda ()
                       (let* ((outline-path (org-get-outline-path t))
                              (file-date (file-name-base (buffer-file-name)))
                              (current-day (calendar-day-of-week (calendar-current-date)))
                              (days-since-monday (if (= current-day 0) 6 (1- current-day)))
                              (week-start (time-subtract (current-time) (seconds-to-time (* days-since-monday 86400))))
                              (saturday-date (format-time-string "%Y%m%d" (time-add week-start (seconds-to-time (* 5 86400))))))
                         (unless (and (or (org-at-heading-p) (org-at-property-p))
                                       (cl-some (lambda (heading)
                                                (string-match-p "Daily Outcomes" heading))
                                              outline-path)
                                       (not (string-match-p "Daily Outcomes" (or (org-get-heading t t t t) "")))
                                       (string-match-p saturday-date file-date))
                           (or (outline-next-heading) (point-max))))))
                   (org-agenda-show-inherited-tags nil)
                   (org-agenda-prefix-format "  %i%(my/agenda-bold-prefix)%?-12t %s")))
            (tags "LEVEL>0"
                  ((org-agenda-overriding-header "ğŸ“… Sunday")
                   (org-agenda-files (directory-files-recursively
                                       (expand-file-name "journal" {{ .org_dir | quote }}) "\\.org$"))
                   (org-agenda-skip-function
                    '(lambda ()
                       (let* ((outline-path (org-get-outline-path t))
                              (file-date (file-name-base (buffer-file-name)))
                              (current-day (calendar-day-of-week (calendar-current-date)))
                              (days-since-monday (if (= current-day 0) 6 (1- current-day)))
                              (week-start (time-subtract (current-time) (seconds-to-time (* days-since-monday 86400))))
                              (sunday-date (format-time-string "%Y%m%d" (time-add week-start (seconds-to-time (* 6 86400))))))
                         (unless (and (or (org-at-heading-p) (org-at-property-p))
                                       (cl-some (lambda (heading)
                                                (string-match-p "Daily Outcomes" heading))
                                              outline-path)
                                       (not (string-match-p "Daily Outcomes" (or (org-get-heading t t t t) "")))
                                       (string-match-p sunday-date file-date))
                           (or (outline-next-heading) (point-max))))))
                   (org-agenda-show-inherited-tags nil)
                   (org-agenda-prefix-format "  %i%(my/agenda-bold-prefix)%?-12t %s")))))

          ;; Eisenhower Matrix (using priorities)
          ("E" "Eisenhower Matrix"
           ((tags-todo "PRIORITY=\"A\""
                       ((org-agenda-overriding-header "ğŸ”¥ Important & Urgent (Priority A)")
                        (org-agenda-skip-function
                         '(lambda ()
                            (org-agenda-skip-entry-if 'todo '("WAITING" "HOLD"))))))
            (tags-todo "PRIORITY=\"B\""
                       ((org-agenda-overriding-header "ğŸ“… Important & Not Urgent (Priority B)")
                        (org-agenda-skip-function
                         '(lambda ()
                            (org-agenda-skip-entry-if 'todo '("WAITING" "HOLD"))))))
            (tags-todo "PRIORITY=\"C\""
                       ((org-agenda-overriding-header "ğŸ‘¥ Not Important & Urgent (Priority C)")
                        (org-agenda-skip-function
                         '(lambda ()
                            (org-agenda-skip-entry-if 'todo '("WAITING" "HOLD"))))))))

          ;; Shopping & Selling Lists
          ("S" "Shopping & Selling"
           ((tags-todo "shopping"
                       ((org-agenda-overriding-header "ğŸ›’ Shopping List")))
            (tags-todo "selling"
                       ((org-agenda-overriding-header "ğŸ’° Selling List")))))))

  (add-hook 'org-agenda-mode-hook 'hl-line-mode)

  (setq org-directory (append (list {{ .org_dir | quote }})
                              (when (file-exists-p (expand-file-name "org" {{ .workspace_extra | quote }}))
                                (list (expand-file-name "org" {{ .workspace_extra | quote }})))))

  (setq org-log-done nil)
  (setq org-todo-repeat-to-state "TODO")
  (setq org-agenda-file-regexp "\\`[^.].*\\.org\\'") ;; Exclude files starting with "."
  (setq org-agenda-files
        (seq-filter (lambda (file)
                      (not (string-match-p "/templates/" file)))
                    (append (directory-files-recursively {{ .org_dir | quote }} "\\.org$")
                            (when (file-exists-p (expand-file-name "org" {{ .workspace_extra | quote }}))
                              (directory-files-recursively (expand-file-name "org" {{ .workspace_extra | quote }}) "\\.org$"))
                            ;; Include journal files in agenda
                            (directory-files-recursively (expand-file-name "journal" {{ .org_dir | quote }}) "\\.org$"))))

  (setq org-default-notes-file (expand-file-name "inbox.org" {{ .org_dir | quote }}))
  (setq org-capture-templates
        '(("t" "Quick todo â†’ inbox.org (no context)" entry (file org-default-notes-file)
           "* TODO %?")
          ("c" "Todo with context â†’ inbox.org (adds link + timestamp)" entry (file org-default-notes-file)
           "* TODO %?\n%U\n  %i\n  %a" :clock-resume t)
          ("P" "Project task â†’ ROADMAP.org in current project" entry (file (lambda ()
                                                (if (projectile-project-p)
                                                     (concat (projectile-project-root) "ROADMAP.org")
                                                   (error "Not in a projectile project"))))
           "* TODO %?\n%U\n  %i\n  %a")
          ("j" "Journal todo â†’ today's journal Todos section" entry (file+headline my/today-journal-file "Todos")
           "* TODO %?" :clock-resume t)
          ("m" "Milestone â†’ milestones.org (with start date)" entry (file my/milestones-file)
           "* %?\n:PROPERTIES:\n:STARTED: %^{Started}t\n:END:\n"
           :empty-lines 1)))

  ;; Return path to today's journal file (used as file+headline capture target)
  (defun my/today-journal-file ()
    "Return path to today's journal file, creating it if needed."
    (let* ((today (format-time-string "%Y%m%dT%H%M%S"))
           (date-title (format-time-string "%Y-%m-%d"))
           (journal-dir (expand-file-name "journal" {{ .org_dir | quote }}))
           (today-file (car (directory-files journal-dir t (format-time-string "%Y-%m-%d")))))
      (or today-file
          (expand-file-name (format "%s--%s__journal.org" today date-title)
                            journal-dir))))

  ;; GTD-style TODO keywords with PROJECT state
  (setq org-todo-keywords
        '((sequence "TODO(t)" "NEXT(n)" "INPROCESS(i)" "|" "DONE(d)")
          (sequence "PROJECT(p)" "|" "DONE(d)" "CANCELLED(c)")
          (sequence "WAITING(w)" "DELEGATED(D)" "HOLD(h)" "|" "CANCELLED(c)")))

  ;; Stuck projects detection (projects without NEXT, WAITING, or DELEGATED actions)
  (setq org-stuck-projects '("project-INBOX" ("NEXT" "WAITING" "DELEGATED") nil ""))

  ;; TODO keyword faces
  (setq org-todo-keyword-faces
        '(("NEXT" :inherit warning)
          ("INPROCESS" :inherit success)
          ("PROJECT" :inherit font-lock-string-face)
          ("WAITING" :inherit font-lock-keyword-face)
          ("HOLD" :inherit font-lock-comment-face)))

  ;; Eisenhower Matrix priority system (A=I-U, B=I-NU, C=NI-U, D=NI-NU)
  (setq org-priority-highest ?A)
  (setq org-priority-lowest ?D)
  (setq org-priority-default ?D)

  ;; Priority faces for Eisenhower Matrix
  (setq org-priority-faces
        '((?A . (:foreground "red" :weight bold))    ; A = I-U (DO)
          (?B . (:foreground "orange" :weight bold)) ; B = I-NU (SCHEDULE)
          (?C . (:foreground "gray" :weight bold)))) ; C = NI-U (DELEGATE)

  ;; Enable habit tracking
  (require 'org-habit)
  (add-to-list 'org-modules 'org-habit)
  (setq org-habit-graph-column 14)
  (setq org-habit-show-habits-only-for-today t)

  ;; Calendar and scheduling configuration
  (setq calendar-week-start-day 1)                ; Start calendar with Monday
  (setq org-agenda-start-on-weekday 1)            ; Start agenda week with Monday
  (setq org-read-date-prefer-future 'time)        ; Prefer future times when scheduling
  (setq org-read-date-force-compatible-dates nil) ; Allow flexible date input
  (setq org-agenda-span 'week)                    ; Show week view by default
  (setq org-agenda-start-day nil)                 ; Start agenda with today
  (setq org-agenda-show-all-dates t)              ; Show all days even if empty

  ;; Today navigation and highlighting
  (setq org-agenda-include-diary nil)                     ; Don't include diary
  (setq org-agenda-skip-scheduled-if-deadline-is-shown t) ; Avoid duplicate entries
  (setq org-deadline-warning-days 0)
  (setq org-scheduled-past-days 365)    ; Show past scheduled items for 365 days
  (setq org-deadline-past-days 365)     ; Show past deadline items for 365 days
  (setq org-scheduled-delay-days 365)   ; Show overdue scheduled items for 365 days

  ;; Fast date selection
  (setq org-popup-calendar-for-date-selection t) ; Show popup calendar for date selection

  ;; Universal clean display for all denote titles in agenda
  (defun my/clean-denote-title-for-agenda ()
    "Show clean denote titles for all agenda items with bold formatting."
    (when (buffer-file-name)
      (let* ((file (file-name-nondirectory (buffer-file-name)))
             (is-journal (string-match-p "journal" (buffer-file-name)))
             (is-outcome (save-excursion
                           (org-back-to-heading t)
                           (let ((outline-path (org-get-outline-path t)))
                             (cl-some (lambda (heading) (string-match-p "Daily Outcomes" heading)) outline-path)))))
        (cond
         ;; Denote journal files - extract date from filename
         (is-journal
          (let* ((title-part (if (string-match "^[0-9T]+--\\([^_]+\\)__" file)
                                 (match-string 1 file)
                               (file-name-sans-extension file)))
                 (icon (if is-outcome "ğŸ†" "ğŸ“")))
            title-part))
         ;; Other denote files
         ((string-match "^[0-9T]+--\\([^_]+\\)__" file)
          (let ((clean-title (replace-regexp-in-string "-" " " (match-string 1 file))))
            (capitalize clean-title)))
         ;; Non-denote files - show just filename without extension
         (t
          (file-name-sans-extension file))))))

  ;; â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ;; Date helper functions for agenda headers
  ;; â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  (defun my/get-end-of-year-date ()
    "Return formatted string for end of current year."
    (format-time-string "[%Y-%m-%d %a]" (encode-time 0 0 0 31 12 (nth 5 (decode-time)))))

  (defun my/get-end-of-quarter-date ()
    "Return formatted string for end of current quarter."
    (let* ((now (current-time))
           (decoded (decode-time now))
           (m (nth 4 decoded))
           (y (nth 5 decoded))
           (end-m (cond ((<= m 3) 3) ((<= m 6) 6) ((<= m 9) 9) (t 12))))
      (format-time-string "[%Y-%m-%d %a]" (encode-time 0 0 0 (if (= end-m 12) 31 30) end-m y))))

  (defun my/get-end-of-month-date ()
    "Return formatted string for end of current month."
    (let* ((now (current-time))
           (decoded (decode-time now))
           (y (nth 5 decoded))
           (m (nth 4 decoded))
           (day (pcase m
                  ((or 1 3 5 7 8 10 12) 31)
                  ((or 4 6 9 11) 30)
                  (2 (if (and (= (mod y 4) 0)
                              (or (/= (mod y 100) 0) (= (mod y 400) 0)))
                         29 28)))))
      (format-time-string "[%Y-%m-%d %a]" (encode-time 0 0 0 day m y))))

  (defun my/get-next-friday-date ()
    "Return formatted string for next Friday (today if Friday)."
    (let* ((now (current-time))
           (dow (string-to-number (format-time-string "%w" now)))
           (days-ahead (if (= dow 5) 0 (- 5 dow)))
           (days-ahead (if (< days-ahead 0) (+ 7 days-ahead) days-ahead)))
      (format-time-string "[%Y-%m-%d %a]" (time-add now (* days-ahead 86400)))))

  (defun my/get-today-date ()
    "Return formatted string for today."
    (format-time-string "[%Y-%m-%d %a]"))

  ;; â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ;; Make filename/title BOLD in agenda â€“ guaranteed to work
  ;; â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  (defun my/agenda-bold-prefix ()
    "Return the cleaned filename/title with arrow separator (bolding applied post-render)."
    (let ((clean (my/clean-denote-title-for-agenda)))
      (when (and clean (not (string-empty-p clean)))
        (concat clean " â†’ "))))

  (defun my/agenda-apply-bold-prefix ()
    "Re-apply bold face to prefix titles after agenda render."
    (save-excursion
      (goto-char (point-min))
      (while (re-search-forward "\\(.+?\\) â†’ " nil t)
        (let ((beg (match-beginning 1))
              (end (match-end 1)))
          (add-face-text-property beg end '(:weight bold))))))

  (defun my/agenda-style-tags ()
    "Style individual tags as separate badges in agenda."
    (save-excursion
      (goto-char (point-min))
      (while (re-search-forward "\\(:[a-zA-Z0-9_@:]+:\\)\\s-*$" nil t)
        (let* ((beg (match-beginning 1))
               (end (match-end 1))
               (tag-str (buffer-substring-no-properties beg end))
               (tags (split-string tag-str ":" t))
               (styled (mapconcat (lambda (tag)
                                    (propertize (concat " " tag " ")
                                                'face '(:foreground "#5B6268" :background "#e8e8e8"
                                                         :weight light :height 0.85)))
                                  tags " ")))
          (let ((inhibit-read-only t))
            (delete-region beg end)
            (goto-char beg)
            (insert styled))))))

  (defun my/agenda-goto-top ()
    "Move cursor to the top of the agenda buffer after finalization."
    (goto-char (point-min)))

  (add-hook 'org-agenda-finalize-hook #'my/agenda-apply-bold-prefix)
  (add-hook 'org-agenda-finalize-hook #'my/agenda-style-tags)

  (setq org-agenda-prefix-format
        '((agenda . " %i%(my/agenda-bold-prefix)%?-12t% s")
          (todo   . " %i%(my/agenda-bold-prefix)")
          (tags   . " %i%(my/agenda-bold-prefix)")
          (search . " %i%(my/agenda-bold-prefix)")))

  ;; Enable multiline agenda items to show full task content
  (setq org-agenda-tags-column -80)
  (setq org-agenda-window-setup 'current-window)
  (setq org-agenda-restore-windows-after-quit t)

  ;; Allow longer lines and wrap text
  (add-hook 'org-agenda-mode-hook
            (lambda ()
              (setq truncate-lines nil)
              (setq word-wrap t)))

  ;; Enhanced refiling system - include all available org directories
  (setq org-refile-targets
        `((nil :maxlevel . 5)
          (org-agenda-files :maxlevel . 5)
          ,@(when (file-exists-p (expand-file-name "org" {{ .workspace_extra | quote }}))
              `((,(directory-files-recursively (expand-file-name "org" {{ .workspace_extra | quote }}) "\\.org$") :maxlevel . 5)))))

  (setq org-refile-use-outline-path t)
  (setq org-outline-path-complete-in-steps nil)
  (setq org-refile-allow-creating-parent-nodes 'confirm)

  ;; Exclude DONE state tasks from refile targets
  (defun my/verify-refile-target ()
    "Exclude todo keywords with a done state from refile targets."
    (not (member (nth 2 (org-heading-components)) org-done-keywords)))
  (setq org-refile-target-verify-function 'my/verify-refile-target)

  ;; Auto-save after refile
  (advice-add 'org-refile :after (lambda (&rest _) (org-save-all-org-buffers)))

  ;; Quick refile to today's journal (under "Todos" heading)
  (defun my/today-journal-rfloc ()
    "Return refile location for today's journal Todos heading."
    (let* ((journal-dir (expand-file-name "journal" denote-directory))
           (date-string (format-time-string "%Y-%m-%d"))
           (files (directory-files journal-dir t (concat date-string ".*\\.org$")))
           (journal-file (car files)))
      (unless journal-file
        (denote-journal-new-or-existing-entry)
        (setq files (directory-files journal-dir t (concat date-string ".*\\.org$")))
        (setq journal-file (car files)))
      (when journal-file
        (with-current-buffer (find-file-noselect journal-file)
          (save-excursion
            (goto-char (point-min))
            (unless (re-search-forward "^\\*+ Todos" nil t)
              (goto-char (point-max))
              (insert "\n* Todos\n")
              (save-buffer))))
        (list "Todos" journal-file nil
              (with-current-buffer (find-file-noselect journal-file)
                (save-excursion
                  (goto-char (point-min))
                  (re-search-forward "^\\*+ Todos" nil t)
                  (point-at-bol)))))))

  (defun my/refile-to-today-journal ()
    "Refile current entry to today's journal under Todos heading.
Works on single entry in org buffer or on all marked entries in agenda."
    (interactive)
    (let ((rfloc (my/today-journal-rfloc)))
      (if (and (eq major-mode 'org-agenda-mode)
               (org-agenda-bulk-marked-entries))
          ;; Bulk refile all marked entries
          (let ((marked (reverse (org-agenda-bulk-marked-entries))))
            (dolist (entry marked)
              (let ((inhibit-message t))
                (org-with-point-at entry
                  (org-refile nil nil rfloc))))
            (org-agenda-bulk-unmark-all)
            (message "Refiled %d items to today's journal â†’ Todos" (length marked)))
        ;; Single entry
        (if (eq major-mode 'org-agenda-mode)
            (org-agenda-refile nil rfloc)
          (org-refile nil nil rfloc))
        (message "Refiled to today's journal â†’ Todos"))))

  ;; Clock tracking configuration
  (setq org-clock-persist t)
  (setq org-clock-in-resume t)
  (setq org-clock-into-drawer t)
  (setq org-log-into-drawer t)
  (setq org-clock-out-remove-zero-time-clocks t)

  (setq org-time-clocksum-format
        '(:hours "%d" :require-hours t :minutes ":%02d" :require-minutes t))

  ;; Archive configuration - use dedicated archive directory
  (setq org-archive-location "archive/%s_archive::")
  (setq org-archive-save-context-info '(time file ltags itags todo category olpath))

  ;; Archive all DONE items in directory
  (defun org-archive-all-done-in-directory (directory)
    "Archive all DONE items in all org files in DIRECTORY."
    (interactive "DDirectory: ")
    (let ((org-files (directory-files-recursively directory "\\.org$")))
      (dolist (file org-files)
        (with-current-buffer (find-file-noselect file)
          (org-archive-all-done)
          (save-buffer)))))

  ;; Archive all DONE items in current org-agenda-files
  (defun org-archive-all-done-in-agenda-files ()
    "Archive all DONE items in all org-agenda-files."
    (interactive)
    (dolist (file org-agenda-files)
      (when (file-exists-p file)
        (with-current-buffer (find-file-noselect file)
          (org-archive-all-done)
          (save-buffer)))))

  ;; Weekly Outcomes Overview (for Friday Reflection reference)
  (defun my/weekly-outcomes-overview ()
    "Show weekly outcomes overview in side window for Friday reflection."
    (interactive)
    (let* ((today (current-time))
           (start-of-week (time-subtract today (seconds-to-time (* (calendar-day-of-week (calendar-current-date)) 86400))))
           (journal-files (directory-files-recursively
                           (expand-file-name "journal" {{ .org_dir | quote }}) "\\.org$"))
           (buffer-name "*Weekly Outcomes*"))

      ;; Create or switch to outcomes buffer
      (with-current-buffer (get-buffer-create buffer-name)
        (erase-buffer)
        (org-mode)

        ;; Insert header
        (insert "* Weekly Outcomes - " (format-time-string "%Y-%m-%d" start-of-week) "\n\n")

        ;; Process each journal file from this week
        (dolist (file journal-files)
          (when (file-readable-p file)
            (let ((file-date (file-attribute-modification-time (file-attributes file))))
              (when (time-less-p start-of-week file-date)
                (with-temp-buffer
                  (insert-file-contents file)
                  (goto-char (point-min))

                  ;; Extract date from filename
                  (let ((date-from-file (if (string-match "\\([0-9]\\{4\\}-[0-9]\\{2\\}-[0-9]\\{2\\}\\)" file)
                                            (match-string 1 file)
                                          "Unknown")))

                    ;; Find Daily Outcomes section
                    (when (re-search-forward "Daily Outcomes" nil t)
                      (with-current-buffer buffer-name
                        (insert "** " date-from-file "\n"))

                      ;; Extract outcomes
                      (let ((outcomes-found nil))
                        (while (re-search-forward "^\\*\\*\\* \\(TODO\\|DONE\\) \\(.+\\)$" nil t)
                          (let ((status (match-string 1))
                                (outcome (match-string 2)))
                            (setq outcomes-found t)
                            (with-current-buffer buffer-name
                              (insert (format "- [%s] %s\n"
                                              (if (string= status "DONE") "X" " ")
                                              outcome)))))

                        (unless outcomes-found
                          (with-current-buffer buffer-name
                            (insert "- No outcomes this day\n")))

                        (with-current-buffer buffer-name
                          (insert "\n")))))))))

          ;; Open in side window
          (display-buffer-in-side-window
           (current-buffer)
           '((side . right) (window-width . 80)))
          (message "Weekly outcomes overview opened. Use in parallel with your journal Friday reflection.")))))

  ;; Dynamic org-attach configuration based on file location
  (defun my/get-attach-dir ()
    "Get attachment directory based on current file location."
    (if (and (buffer-file-name)
             (file-exists-p (expand-file-name "org" {{ .workspace_extra | quote }}))
             (string-match-p (expand-file-name "org" {{ .workspace_extra | quote }}) (buffer-file-name)))
        ;; File is in extra workspace - use extra attach dir
        (expand-file-name ".attach/org" {{ .workspace_extra | quote }})
      ;; Default to primary attach dir
      (expand-file-name ".attach" {{ .org_dir | quote }})))

  (defun my/set-attach-dir ()
    "Set org-attach-id-dir based on current buffer location."
    (setq org-attach-id-dir (my/get-attach-dir))
    ;; Create attach directory if it doesn't exist
    (unless (file-exists-p org-attach-id-dir)
      (make-directory org-attach-id-dir t)))

  ;; Set initial attach directory
  (setq org-attach-id-dir (expand-file-name ".attach" {{ .org_dir | quote }}))
  (setq org-attach-dir-relative t)
  (setq org-attach-use-inheritance t)
  (setq org-attach-auto-tag "attach")
  (setq org-attach-store-link-p t)      ; Store link when attaching


  ;; Update attach directory when switching buffers
  (add-hook 'org-mode-hook #'my/set-attach-dir)
  (add-hook 'find-file-hook #'my/set-attach-dir)

  ;; Create primary attach directory if it doesn't exist
  (unless (file-exists-p org-attach-id-dir)
    (make-directory org-attach-id-dir t))

  ;; Function to choose file from disk and attach with link
  (defun my/org-attach-file-and-insert-link ()
    "Choose file from disk, attach it, and insert link automatically."
    (interactive)
    (let ((file (read-file-name "Choose file to attach: " nil nil t)))
      (when (and file (file-exists-p file))
        (my/org-attach-single-file file))))

  ;; Function to choose multiple files from disk and attach with links
  (defun my/org-attach-multiple-files-and-insert-links ()
    "Choose multiple files from disk using completion interface."
    (interactive)
    (let* ((directory (read-directory-name "Choose directory to select files from: "))
           (all-files (directory-files directory t "^[^.]")) ; Exclude hidden files
           (file-names (mapcar (lambda (f)
                                 (cons (file-name-nondirectory f) f))
                               all-files))
           (selected-files '()))

      ;; Use completing-read-multiple for multi-selection
      (let ((selected-names (completing-read-multiple
                             "Select files to attach (use TAB and separate with comma): "
                             file-names)))

        ;; Get full paths for selected files
        (dolist (name selected-names)
          (let ((full-path (cdr (assoc name file-names))))
            (when full-path
              (push full-path selected-files))))

        ;; Reverse to maintain selection order
        (setq selected-files (reverse selected-files))

        (if selected-files
            (progn
              ;; Ensure we have ID and attach tag (only once for all files)
              (unless (org-entry-get nil "ID")
                (org-id-get-create))
              (org-toggle-tag "attach" 'on)

              ;; Process each file
              (dolist (file selected-files)
                (my/org-attach-single-file file))
              (message "Attached %d files" (length selected-files)))
          (message "No files selected")))))

  ;; Helper function to copy file to shared .attach dir
  (defun my/convert-heic-to-jpeg (file)
    "Convert HEIC file to JPEG, return new path. Return FILE unchanged if not HEIC."
    (if (string-match-p "\\.heic$" (downcase file))
        (let ((jpeg-file (concat (file-name-sans-extension file) ".jpg")))
          (if (eq 0 (call-process "sips" nil nil nil "-s" "format" "jpeg"
                                  file "--out" jpeg-file))
              (progn (message "Converted HEIC â†’ JPEG: %s" (file-name-nondirectory jpeg-file))
                     jpeg-file)
            (message "HEIC conversion failed, using original")
            file))
      file))

  (defun my/org-attach-single-file (file)
    "Copy file to shared .attach directory and insert direct link.
HEIC files are auto-converted to JPEG."
    (when (and file (file-exists-p file))
      (setq file (my/convert-heic-to-jpeg file))
      (let* ((assets-dir (my/get-attach-dir))
             (filename (file-name-nondirectory file))
             (destination (expand-file-name filename assets-dir)))

        ;; Create assets dir if needed
        (unless (file-exists-p assets-dir)
          (make-directory assets-dir t))

        ;; Handle duplicate filenames
        (when (file-exists-p destination)
          (let ((base (file-name-sans-extension filename))
                (ext (file-name-extension filename t))
                (counter 1))
            (while (file-exists-p destination)
              (setq filename (format "%s-%d%s" base counter ext))
              (setq destination (expand-file-name filename assets-dir))
              (setq counter (1+ counter)))))

        ;; Copy the file
        (copy-file file destination)

        ;; Insert the link
        (when (string-match-p "\\.(jpg\\|jpeg\\|png\\|gif\\|svg\\|bmp\\|webp)$" filename)
          (insert "#+ATTR_ORG: :width 500\n"))
        (let ((rel-path (file-relative-name
                         (expand-file-name filename assets-dir)
                         (file-name-directory (buffer-file-name)))))
          (insert (format "[[file:%s]]\n" rel-path)))))

    ;; Show inline images after all files are processed
    (org-display-inline-images))

  ;; Drag-and-drop: copy image to shared .attach dir, insert direct file link
  (defun my/org-dnd-file-handler (uri action)
    "Handle drag-and-drop files by copying to the shared .attach directory.
HEIC files are auto-converted to JPEG."
    (let ((file (dnd-get-local-file-name uri t)))
      (when (and file (file-exists-p file))
        (setq file (my/convert-heic-to-jpeg file))
        (let* ((assets-dir (my/get-attach-dir))
               (filename (file-name-nondirectory file))
               (destination (expand-file-name filename assets-dir)))

          ;; Create assets dir if needed
          (unless (file-exists-p assets-dir)
            (make-directory assets-dir t))

          ;; Handle duplicate filenames
          (when (file-exists-p destination)
            (let ((base (file-name-sans-extension filename))
                  (ext (file-name-extension filename t))
                  (counter 1))
              (while (file-exists-p destination)
                (setq filename (format "%s-%d%s" base counter ext))
                (setq destination (expand-file-name filename assets-dir))
                (setq counter (1+ counter)))))

          ;; Copy file
          (copy-file file destination)

          ;; Insert link
          (when (string-match-p "\\.(jpg\\|jpeg\\|png\\|gif\\|svg\\|bmp\\|webp)$" filename)
            (insert "#+ATTR_ORG: :width 500\n"))
          (let ((rel-path (file-relative-name
                           (expand-file-name filename assets-dir)
                           (file-name-directory (buffer-file-name)))))
            (insert (format "[[file:%s]]" rel-path)))
          (insert "\n")

          ;; Show inline
          (org-display-inline-images))

        'private)))

  ;; Set the drag-and-drop handler for org-mode
  (add-hook 'org-mode-hook
            (lambda ()
              (setq-local dnd-protocol-alist
                          (cons '("^file:" . my/org-dnd-file-handler)
                                dnd-protocol-alist))))

  (defvar org-default-time "8:00"
    "The default time for deadlines.")

  ;; =====================================================================
  ;; IMAGE DISPLAY CONFIGURATION
  ;; =====================================================================

  ;; Set default image width for org-mode inline images
  (setq org-image-actual-width '(500))  ; Fixed width of 500 pixels
  ;; Alternative options:
  ;; (setq org-image-actual-width t)     ; Use actual image size
  ;; (setq org-image-actual-width nil)   ; Use #+ATTR_ORG: :width specifications
  ;; (setq org-image-actual-width 300)   ; Fixed width of 300 pixels
  ;; (setq org-image-actual-width '(300 600)) ; Min 300px, max 600px

  ;; Automatically display images when opening org files
  (setq org-startup-with-inline-images t)

  ;; Function to resize all images in current buffer
  (defun my/org-resize-images (width)
    "Resize all images in current buffer to specified width."
    (interactive "nImage width (pixels): ")
    (setq org-image-actual-width (list width))
    (org-redisplay-inline-images))

  ;; Quick resize functions
  (defun my/org-images-small ()
    "Set images to small size (300px)."
    (interactive)
    (my/org-resize-images 300))

  (defun my/org-images-medium ()
    "Set images to medium size (500px)."
    (interactive)
    (my/org-resize-images 500))

  (defun my/org-images-large ()
    "Set images to large size (900px)."
    (interactive)
    (my/org-resize-images 900))

  (defun my/org-images-actual ()
    "Show images at actual size."
    (interactive)
    (setq org-image-actual-width t)
    (org-redisplay-inline-images))

  ;; =====================================================================
  ;; JOURNELLY JOURNAL FUNCTIONS
  ;; =====================================================================

  (defun my/journal-find-same-day-previous-years ()
    "Find journal entries from the same day in previous years (excluding current year)."
    (interactive)
    (let* ((today (format-time-string "%m-%d"))
           (current-year (format-time-string "%Y"))
           (journal-file (expand-file-name "Journelly.org" {{ .org_dir | quote }})))
      (if (file-exists-p journal-file)
          (progn
            (find-file journal-file)
            (goto-char (point-min))
            ;; Create regex that matches same day but excludes current year
            (let ((regex (concat "\\[\\(20[0-9][0-9]\\)-" today "\\)")))
              (multi-occur (list (current-buffer)) regex)
              ;; Filter out current year entries manually
              (with-current-buffer "*Occur*"
                (goto-char (point-min))
                (while (re-search-forward (concat "\\[" current-year "-" today) nil t)
                  (beginning-of-line)
                  (let ((inhibit-read-only t))
                    (delete-region (point) (progn (forward-line 1) (point))))))))
        (message "Journal file not found: %s" journal-file))))

  (defun my/journal-search-by-tag (tag)
    "Search journal entries by hashtag."
    (interactive "sEnter hashtag (without #): ")
    (let ((journal-file (expand-file-name "Journelly.org" {{ .org_dir | quote }})))
      (if (file-exists-p journal-file)
          (progn
            (find-file journal-file)
            (goto-char (point-min))
            (occur (concat "#" tag)))
        (message "Journal file not found: %s" journal-file))))

  (defun my/journal-find-entries-by-date (date)
    "Find journal entries for a specific date (YYYY-MM-DD)."
    (interactive "sEnter date (YYYY-MM-DD): ")
    (let ((journal-file (expand-file-name "Journelly.org" {{ .org_dir | quote }})))
      (if (file-exists-p journal-file)
          (progn
            (find-file journal-file)
            (goto-char (point-min))
            (occur (concat "\\[" date)))
        (message "Journal file not found: %s" journal-file))))

  (defun my/journal-find-location (location)
    "Search journal entries by location."
    (interactive "sEnter location: ")
    (let ((journal-file (expand-file-name "Journelly.org" {{ .org_dir | quote }})))
      (if (file-exists-p journal-file)
          (progn
            (find-file journal-file)
            (goto-char (point-min))
            (occur location))
        (message "Journal file not found: %s" journal-file)))))

  ;; Quick access to Journelly.org file
  (defun my/open-journelly ()
    "Quickly open the Journelly.org journal file."
    (interactive)
    (find-file (expand-file-name "Journelly.org" {{ .org_dir | quote }})))

  ;; â”€â”€ On This Day â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ;; Entry format: (years-ago year location body source images)
  ;; source: 'journelly or 'denote
  ;; images: list of absolute file paths

  (defun my/on-this-day-for-date (month day)
    "Find journal entries for MONTH/DAY in previous years.
Searches both Journelly.org and denote journal files.
Returns list of (years-ago year location body source images)."
    (let* ((current-year (string-to-number (format-time-string "%Y")))
           (m (format "%02d" month))
           (d (format "%02d" day))
           (journelly-file (expand-file-name "Journelly.org" {{ .org_dir | quote }}))
           (journelly-dir (file-name-directory journelly-file))
           (journal-dir (expand-file-name "journal" denote-directory))
           (results '()))

      ;; Search Journelly.org
      (when (file-exists-p journelly-file)
        (with-temp-buffer
          (insert-file-contents journelly-file)
          (goto-char (point-min))
          (while (re-search-forward
                  (format "^\\* \\[\\([0-9]\\{4\\}\\)-%s-%s [A-Za-z]+ [0-9:]+\\]\\(.*\\)" m d)
                  nil t)
            (let* ((year (string-to-number (match-string 1)))
                   (location (match-string 2))
                   (years-ago (- current-year year))
                   (content-start (point))
                   (content-end (or (save-excursion
                                      (when (re-search-forward "^\\* " nil t)
                                        (line-beginning-position)))
                                    (point-max)))
                   (raw (buffer-substring-no-properties content-start content-end))
                   ;; Extract image paths
                   (images (let (imgs)
                             (with-temp-buffer
                               (insert raw)
                               (goto-char (point-min))
                               (while (re-search-forward "\\[\\[file:\\([^]]+\\)\\]\\]" nil t)
                                 (let ((img (match-string 1)))
                                   (push (expand-file-name img journelly-dir) imgs))))
                             (nreverse imgs)))
                   (body (string-trim
                          (replace-regexp-in-string
                           "\\[\\[file:.*\\]\\]" ""
                           (replace-regexp-in-string
                            ":PROPERTIES:[\n\r]\\(.\\|\n\\)*?:END:" ""
                            raw)))))
              (when (> years-ago 0)
                (push (list years-ago year (string-trim (or location ""))
                            (if (> (length body) 120)
                                (concat (substring body 0 120) "...")
                              body)
                            'journelly images
                            journelly-file content-start)
                      results))))))

      ;; Search denote journal files
      (when (file-exists-p journal-dir)
        (dolist (file (directory-files journal-dir t "\\.org$"))
          (let ((fname (file-name-nondirectory file)))
            (when (string-match (format "\\([0-9]\\{4\\}\\)%s%s" m d) fname)
              (let* ((year (string-to-number (match-string 1 fname)))
                     (years-ago (- current-year year)))
                (when (> years-ago 0)
                  (with-temp-buffer
                    (insert-file-contents file)
                    (let* ((raw (buffer-substring-no-properties
                                 (point-min) (min (point-max) (+ (point-min) 800))))
                           (images (let (imgs)
                                     (goto-char (point-min))
                                     (while (re-search-forward "\\[\\[file:\\([^]]+\\)\\]\\]" nil t)
                                       (let ((img (match-string 1)))
                                         (push (expand-file-name img (file-name-directory file)) imgs)))
                                     (nreverse imgs)))
                           (body (string-trim
                                   (replace-regexp-in-string
                                    "^#\\+.*\n" "" raw))))
                      (push (list years-ago year ""
                                  (if (> (length body) 120)
                                      (concat (substring body 0 120) "...")
                                    body)
                                  'denote images
                                  file nil)
                            results)))))))))

      ;; Sort by years ago
      (sort results (lambda (a b) (< (car a) (car b))))))

  (defun my/on-this-day ()
    "Show journal entries from today's date in previous years."
    (interactive)
    (let* ((month (string-to-number (format-time-string "%m")))
           (day (string-to-number (format-time-string "%d")))
           (results (my/on-this-day-for-date month day)))
      (if results
          (mapconcat
           (lambda (e)
             (format "  %dy ago (%d)%s %s"
                     (nth 0 e) (nth 1 e)
                     (if (and (nth 2 e) (not (string-empty-p (nth 2 e))))
                         (concat " " (nth 2 e)) "")
                     (nth 3 e)))
           results "\n")
        "  No entries found for this date")))

  (defun my/on-this-day-buffer ()
    "Open a buffer showing On This Day entries for today Â±5 days."
    (interactive)
    (let ((buf (get-buffer-create "*On This Day*")))
      (with-current-buffer buf
        (let ((inhibit-read-only t))
          (erase-buffer)
          (org-mode)
          (insert "#+title: On This Day\n\n")
          (dotimes (offset 11)
            (let* ((day-offset (- offset 5))
                   (target-time (time-add (current-time) (days-to-time day-offset)))
                   (month (string-to-number (format-time-string "%m" target-time)))
                   (day (string-to-number (format-time-string "%d" target-time)))
                   (date-str (format-time-string "%B %d" target-time))
                   (label (cond ((= day-offset 0) (format "* Today â€” %s\n" date-str))
                                ((= day-offset -1) (format "* Yesterday â€” %s\n" date-str))
                                ((= day-offset 1) (format "* Tomorrow â€” %s\n" date-str))
                                ((< day-offset 0) (format "* %dd ago â€” %s\n" (abs day-offset) date-str))
                                (t (format "* +%dd â€” %s\n" day-offset date-str))))
                   (results (my/on-this-day-for-date month day)))
              (when results
                (insert label)
                (dolist (e results)
                  (insert (format "** %dy ago (%d)%s\n%s\n\n"
                                  (nth 0 e) (nth 1 e)
                                  (if (and (nth 2 e) (not (string-empty-p (nth 2 e))))
                                      (concat " " (nth 2 e)) "")
                                  (nth 3 e))))))))
        (goto-char (point-min))
        (read-only-mode 1))
      (switch-to-buffer buf)))

  (defun my/agenda-on-this-day ()
    "Insert 'On This Day' section into dashboard agenda."
    (let ((inhibit-read-only t))
      (goto-char (point-max))
      (insert "\n")
      (insert (propertize "ğŸ“… On This Day" 'face 'org-agenda-structure) "\n")
      (insert (my/on-this-day) "\n")))

  (defun my/on-this-day-source-badge (source)
    "Return a styled badge for SOURCE ('journelly or 'denote)."
    (if (eq source 'journelly)
        (propertize " Journelly " 'face '(:foreground "#5B6268" :background "#e8e8e8" :height 0.85))
      (propertize " Denote " 'face '(:foreground "#5B6268" :background "#d4eaff" :height 0.85))))

  (defun my/on-this-day-insert-images (images)
    "Insert inline images from IMAGES list into current buffer."
    (dolist (img images)
      (when (and img (file-exists-p img)
                 (string-match-p "\\.\\(jpg\\|jpeg\\|png\\|gif\\|bmp\\|webp\\)$" (downcase img)))
        (let ((start (point)))
          (insert-image (create-image img nil nil :width 300))
          (insert "\n")))))

  (defun my/on-this-day-open-source ()
    "Open the source file for the entry at point."
    (interactive)
    (let ((file (get-text-property (point) 'otd-file))
          (pos (get-text-property (point) 'otd-pos)))
      (if file
          (progn
            (find-file file)
            (when pos (goto-char pos))
            (org-show-entry))
        (message "No source file for this line"))))

  (defvar my/otd-offset 0
    "Current day offset for On This Day view. 0 = today, -1 = yesterday, etc.")

  (defvar my/on-this-day-map
    (let ((map (make-sparse-keymap)))
      (define-key map (kbd "RET") #'my/on-this-day-open-source)
      (define-key map (kbd "TAB") #'my/on-this-day-open-source)
      (define-key map (kbd "[") (lambda () (interactive) (my/otd-navigate -1)))
      (define-key map (kbd "]") (lambda () (interactive) (my/otd-navigate 1)))
      (define-key map (kbd "0") #'my/otd-go-today)
      (define-key map (kbd "q") #'quit-window)
      map)
    "Keymap for On This Day agenda buffer.")

  (defun my/otd-navigate (delta)
    "Shift On This Day view by DELTA days and redraw."
    (setq my/otd-offset (+ my/otd-offset delta))
    (my/agenda-on-this-day-full))

  (defun my/otd-go-today ()
    "Jump back to today in On This Day view."
    (interactive)
    (setq my/otd-offset 0)
    (my/agenda-on-this-day-full))

  (defun my/agenda-on-this-day-full ()
    "Show On This Day for a single day. Navigate with [ / ] / 0."
    (let* ((inhibit-read-only t)
           (target-time (time-add (current-time) (days-to-time my/otd-offset)))
           (month (string-to-number (format-time-string "%m" target-time)))
           (day (string-to-number (format-time-string "%d" target-time)))
           (date-str (format-time-string "%A, %B %d" target-time))
           (is-today (= my/otd-offset 0))
           (label (cond (is-today (format "â˜€ï¸ Today â€” %s" date-str))
                        ((= my/otd-offset -1) (format "â—€ Yesterday â€” %s" date-str))
                        ((= my/otd-offset 1) (format "â–¶ Tomorrow â€” %s" date-str))
                        ((< my/otd-offset 0) (format "â—€ %d days ago â€” %s" (abs my/otd-offset) date-str))
                        (t (format "â–¶ +%d days â€” %s" my/otd-offset date-str))))
           (results (my/on-this-day-for-date month day)))
      (erase-buffer)
      (insert (propertize "ğŸ“… On This Day\n" 'face 'org-agenda-structure))
      (insert (propertize "  [ prev   ] next   0 today   RET open   q quit\n\n"
                          'face 'font-lock-comment-face))
      (insert (propertize (concat label "\n") 'face (if is-today 'org-agenda-date-today 'org-agenda-date)))
      (if results
          (dolist (e results)
            (let ((source (nth 4 e))
                  (images (nth 5 e))
                  (file (nth 6 e))
                  (pos (nth 7 e))
                  (entry-start (point)))
              (insert (format "  %dy ago (%d)%s " (nth 0 e) (nth 1 e)
                              (if (and (nth 2 e) (not (string-empty-p (nth 2 e))))
                                  (nth 2 e) "")))
              (insert (my/on-this-day-source-badge source))
              (insert (format "\n  %s\n" (nth 3 e)))
              (when images
                (insert "  ")
                (my/on-this-day-insert-images (seq-take images 2)))
              (put-text-property entry-start (point) 'otd-file file)
              (put-text-property entry-start (point) 'otd-pos pos)
              (put-text-property entry-start (point) 'keymap my/on-this-day-map)))
        (insert (propertize "  No memories for this day yet.\n" 'face 'font-lock-comment-face)))
      (use-local-map my/on-this-day-map)
      (goto-char (point-min))))

  ;; â”€â”€ Milestones â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ;; Track life milestones with `:STARTED:` property and see elapsed time.
  ;; Format: org headings with :STARTED: [2020-02-16 Sun 11:00] property.

  (defvar my/milestones-file
    (expand-file-name "milestones.org" {{ .org_dir | quote }})
    "File containing milestone entries.")

  (defun my/milestone-elapsed (start-time)
    "Return human-readable elapsed string since START-TIME."
    (let* ((now (decode-time))
           (start (decode-time start-time))
           (years (- (nth 5 now) (nth 5 start)))
           (months (- (nth 4 now) (nth 4 start)))
           (days (- (nth 3 now) (nth 3 start))))
      (when (< days 0)
        (cl-decf months)
        (setq days (+ days 30)))
      (when (< months 0)
        (cl-decf years)
        (setq months (+ months 12)))
      (let ((parts '()))
        (when (> years 0) (push (format "%dy" years) parts))
        (when (> months 0) (push (format "%dm" months) parts))
        (when (> days 0) (push (format "%dd" days) parts))
        (if parts (string-join (nreverse parts) " ") "today"))))

  (defun my/milestone-total-days (start-time)
    "Return total days since START-TIME."
    (floor (/ (float-time (time-subtract (current-time) start-time)) 86400)))

  (defun my/milestones-parse ()
    "Parse milestones file. Returns list of (title started-time tags pos)."
    (let ((results '()))
      (when (file-exists-p my/milestones-file)
        (with-temp-buffer
          (insert-file-contents my/milestones-file)
          (org-mode)
          (goto-char (point-min))
          (while (re-search-forward "^\\*+ " nil t)
            (let* ((heading (org-get-heading t t t t))
                   (pos (line-beginning-position))
                   (tags (org-get-tags))
                   (started-str (org-entry-get (point) "STARTED")))
              (when started-str
                (let ((started-time (org-parse-time-string started-str)))
                  (push (list heading
                              (apply #'encode-time started-time)
                              tags pos)
                        results)))))))
      (nreverse results)))

  (defun my/agenda-milestones-full ()
    "Insert milestones into agenda buffer as a dedicated view."
    (let ((milestones (my/milestones-parse))
          (inhibit-read-only t))
      (erase-buffer)
      (insert (propertize "ğŸ† Milestones\n" 'face 'org-agenda-structure))
      (insert (propertize "  RET/TAB to open source, q to quit\n\n"
                          'face 'font-lock-comment-face))
      (if (null milestones)
          (insert (propertize "  No milestones found.\n" 'face 'font-lock-comment-face))
        (dolist (m milestones)
          (let ((entry-start (point))
                (title (nth 0 m))
                (started (nth 1 m))
                (tags (nth 2 m))
                (pos (nth 3 m)))
            (insert (propertize (format "  %s" title) 'face 'org-level-2))
            (when tags
              (insert " "
                      (propertize (mapconcat (lambda (tag) (format ":%s:" tag)) tags "")
                                  'face 'org-tag)))
            (insert "\n")
            (insert "  ")
            (insert (propertize (my/milestone-elapsed started) 'face 'success))
            (insert (propertize (format "  (%d days)" (my/milestone-total-days started))
                                'face 'font-lock-comment-face))
            (insert (propertize (format "  since %s"
                                        (format-time-string "%b %d, %Y" started))
                                'face 'font-lock-comment-face))
            (insert "\n\n")
            (put-text-property entry-start (point) 'otd-file my/milestones-file)
            (put-text-property entry-start (point) 'otd-pos pos)
            (put-text-property entry-start (point) 'keymap my/on-this-day-map))))
      (use-local-map my/on-this-day-map)
      (goto-char (point-min))))

  (defun my/agenda-milestones ()
    "Insert milestones section into agenda buffer."
    (let ((milestones (my/milestones-parse))
          (inhibit-read-only t))
      (when milestones
        (goto-char (point-max))
        (insert "\n" (propertize "ğŸ† Milestones" 'face 'org-agenda-structure) "\n")
        (dolist (m milestones)
          (let ((title (nth 0 m))
                (started (nth 1 m)))
            (insert (format "  %s â€” " title))
            (insert (propertize (my/milestone-elapsed started) 'face 'success))
            (insert (propertize (format " (%d days)"
                                        (my/milestone-total-days started))
                                'face 'font-lock-comment-face))
            (insert "\n"))))))

  ;; â”€â”€ Graveyard (RIP) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  (defun my/graveyard-parse ()
    "Parse all #RIP entries from Journelly.org.
Returns list of (date-str body images file pos) sorted newest first."
    (let* ((journelly-file (expand-file-name "Journelly.org" {{ .org_dir | quote }}))
           (journelly-dir (file-name-directory journelly-file))
           (entries '()))
      (when (file-exists-p journelly-file)
        (with-temp-buffer
          (insert-file-contents journelly-file)
          (goto-char (point-min))
          (while (re-search-forward
                  "^\\* \\[\\([0-9-]+ [A-Za-z]+ [0-9:]+\\)\\]\\(.*\\)" nil t)
            (let* ((date-str (match-string 1))
                   (location (string-trim (or (match-string 2) "")))
                   (heading-pos (line-beginning-position))
                   (content-start (point))
                   (content-end (or (save-excursion
                                      (when (re-search-forward "^\\* " nil t)
                                        (line-beginning-position)))
                                    (point-max)))
                   (raw (buffer-substring-no-properties content-start content-end)))
              (when (string-match-p "#RIP\\b" (concat location " " raw))
                (let* ((images (let (imgs)
                                 (with-temp-buffer
                                   (insert raw)
                                   (goto-char (point-min))
                                   (while (re-search-forward "\\[\\[file:\\([^]]+\\)\\]\\]" nil t)
                                     (push (expand-file-name (match-string 1) journelly-dir) imgs)))
                                 (nreverse imgs)))
                       (body (string-trim
                              (replace-regexp-in-string
                               "#RIP" ""
                               (replace-regexp-in-string
                                "\\[\\[file:.*\\]\\]" ""
                                (replace-regexp-in-string
                                 ":PROPERTIES:[\n\r]\\(.\\|\n\\)*?:END:" "" raw))))))
                  (push (list date-str body images journelly-file heading-pos)
                        entries)))))))
      (nreverse entries)))

  (defun my/agenda-graveyard-full ()
    "Insert Graveyard (RIP) entries into agenda buffer."
    (let ((entries (my/graveyard-parse))
          (inhibit-read-only t))
      (erase-buffer)
      (insert (propertize "ğŸª¦ Graveyard\n" 'face 'org-agenda-structure))
      (insert (propertize "  RET/TAB to open source, q to quit\n\n"
                          'face 'font-lock-comment-face))
      (if (null entries)
          (insert (propertize "  No entries found.\n" 'face 'font-lock-comment-face))
        (dolist (e entries)
          (let ((entry-start (point))
                (date-str (nth 0 e))
                (body (nth 1 e))
                (images (nth 2 e))
                (file (nth 3 e))
                (pos (nth 4 e)))
            (insert (propertize (format "  %s\n" date-str) 'face 'org-agenda-date))
            (let ((body-clean (string-trim body)))
              (when (and body-clean (not (string-empty-p body-clean)))
                (let ((first-line (car (split-string body-clean "\n"))))
                  (insert (format "  %s\n"
                                  (if (> (length first-line) 120)
                                      (concat (substring first-line 0 120) "...")
                                    first-line))))))
            (when images
              (insert "  ")
              (my/on-this-day-insert-images (seq-take images 2)))
            (insert "\n")
            (put-text-property entry-start (point) 'otd-file file)
            (put-text-property entry-start (point) 'otd-pos pos)
            (put-text-property entry-start (point) 'keymap my/on-this-day-map))))
      (use-local-map my/on-this-day-map)
      (goto-char (point-min))))

  ;; â”€â”€ Journelly Tag Search â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  (defun my/journelly-search-tag (tag)
    "Search Journelly.org for entries containing #TAG.
Shows results in a navigable buffer with dates, locations, body, and images."
    (interactive
     (list (completing-read "Journelly tag: "
                            (my/journelly-collect-tags) nil nil)))
    (let* ((tag-clean (replace-regexp-in-string "^#" "" tag))
           (journelly-file (expand-file-name "Journelly.org" {{ .org_dir | quote }}))
           (journelly-dir (file-name-directory journelly-file))
           (entries '()))
      (unless (file-exists-p journelly-file)
        (user-error "Journelly.org not found"))
      ;; Parse entries matching tag
      (with-temp-buffer
        (insert-file-contents journelly-file)
        (goto-char (point-min))
        (while (re-search-forward
                "^\\* \\[\\([0-9-]+ [A-Za-z]+ [0-9:]+\\)\\]\\(.*\\)" nil t)
          (let* ((date-str (match-string 1))
                 (location (string-trim (or (match-string 2) "")))
                 (location (replace-regexp-in-string "^@ *" "" location))
                 (heading-pos (line-beginning-position))
                 (content-start (point))
                 (content-end (or (save-excursion
                                    (when (re-search-forward "^\\* " nil t)
                                      (line-beginning-position)))
                                  (point-max)))
                 (raw (buffer-substring-no-properties content-start content-end)))
            (when (string-match-p (format "#%s\\b" (regexp-quote tag-clean))
                                  (concat location " " raw))
              (let* ((images (let (imgs)
                               (with-temp-buffer
                                 (insert raw)
                                 (goto-char (point-min))
                                 (while (re-search-forward "\\[\\[file:\\([^]]+\\)\\]\\]" nil t)
                                   (push (expand-file-name (match-string 1) journelly-dir) imgs)))
                               (nreverse imgs)))
                     (body (string-trim
                            (replace-regexp-in-string
                             "\\[\\[file:.*\\]\\]" ""
                             (replace-regexp-in-string
                              ":PROPERTIES:[\n\r]\\(.\\|\n\\)*?:END:" "" raw)))))
                (push (list date-str location
                            (if (> (length body) 200)
                                (concat (substring body 0 200) "...")
                              body)
                            images journelly-file heading-pos)
                      entries))))))
      (setq entries (nreverse entries))
      ;; Render buffer
      (let ((buf (get-buffer-create (format "*Journelly #%s*" tag-clean))))
        (with-current-buffer buf
          (let ((inhibit-read-only t))
            (erase-buffer)
            (insert (propertize (format "ğŸ· Journelly #%s" tag-clean)
                                'face 'org-agenda-structure))
            (insert (propertize (format "  (%d entries)\n" (length entries))
                                'face 'font-lock-comment-face))
            (insert (propertize "  RET/TAB to open source, q to quit\n\n"
                                'face 'font-lock-comment-face))
            (if (null entries)
                (insert (propertize "  No entries found.\n" 'face 'font-lock-comment-face))
              (dolist (e entries)
                (let ((entry-start (point)))
                  (insert (propertize (format "  %s" (nth 0 e)) 'face 'org-agenda-date))
                  (when (and (nth 1 e) (not (string-empty-p (nth 1 e))))
                    (insert (propertize (format "  ğŸ“ %s" (nth 1 e))
                                        'face 'font-lock-comment-face)))
                  (insert "\n")
                  (let ((body (nth 2 e)))
                    (when (and body (not (string-empty-p body)))
                      (insert (format "  %s\n" body))))
                  (when (nth 3 e)
                    (insert "  ")
                    (my/on-this-day-insert-images (seq-take (nth 3 e) 2)))
                  (put-text-property entry-start (point) 'otd-file (nth 4 e))
                  (put-text-property entry-start (point) 'otd-pos (nth 5 e))
                  (put-text-property entry-start (point) 'keymap my/on-this-day-map)
                  (insert "\n")))))
          (use-local-map my/on-this-day-map)
          (goto-char (point-min))
          (read-only-mode 1))
        (switch-to-buffer buf))))

  (defun my/journelly-collect-tags ()
    "Collect all unique #tags from Journelly.org."
    (let ((journelly-file (expand-file-name "Journelly.org" {{ .org_dir | quote }}))
          (tags '()))
      (when (file-exists-p journelly-file)
        (with-temp-buffer
          (insert-file-contents journelly-file)
          (goto-char (point-min))
          (while (re-search-forward "#\\([[:alnum:]_]+\\)" nil t)
            (push (match-string 1) tags))))
      (delete-dups (mapcar #'downcase tags))))

;; Reset function for checklists
(defun my/org-reset-checklist ()
  "Reset all DONE items to TODO and uncheck all checkboxes in current buffer."
  (interactive)
  (save-excursion
    (goto-char (point-min))
    (let ((todo-count 0)
          (checkbox-count 0))

      ;; Reset DONE/CANCELLED to TODO while preserving heading levels
      (while (re-search-forward "^\\(\\*+\\) \\(DONE\\|CANCELLED\\) " nil t)
        (replace-match "\\1 TODO " nil nil)
        (setq todo-count (1+ todo-count)))

      ;; Reset checked checkboxes to unchecked
      (goto-char (point-min))
      (while (re-search-forward "^[ \t]*- \\[X\\]" nil t)
        (replace-match "- [ ]" nil nil)
        (setq checkbox-count (1+ checkbox-count)))

      ;; Remove logbook entries
      (goto-char (point-min))
      (while (re-search-forward ":LOGBOOK:\n\\(.*\n\\)*?:END:" nil t)
        (replace-match ""))

      (message "Reset %d TODO items and %d checkboxes" todo-count checkbox-count))))

;; â”€â”€ Link capture â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
;; org-cliplink: paste URL from clipboard as [[url][page title]] org link
(use-package! org-cliplink
  :after org)

(provide 'init-org)
