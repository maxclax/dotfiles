;;; init-dired.el -*- mode: emacs-lisp; lexical-binding: t; -*-

(after! dirvish
  ;; Enable dirvish globally for all dired buffers
  (dirvish-override-dired-mode)

  ;; GNU ls (Nix coreutils) supports --group-directories-first; BSD ls does not.
  ;; Set after dirvish-override-dired-mode so dirvish doesn't reset it.
  (setq dired-listing-switches "-aBhl --group-directories-first")

  (setq dirvish-attributes
        '(vc-state file-size nerd-icons collapse file-time))

  (setq dirvish-quick-access-entries
        `(("h" "~/" "Home")
          ("c" "~/.config" "config")
          ("l" "~/.local" "local")
          ("d" "~/Desktop" "Desktop")
          ("D" "~/Downloads" "Downloads")
          ("I" ,(expand-file-name "~/icloud/Downloads") "Downloads (iCloud)")
          ("o" ,(expand-file-name {{ .org_dir | quote }}) "Org dir")

          ("w" ,(expand-file-name {{ .workspace | quote }}) "Workspace")
          ("W" ,(expand-file-name {{ .workspace_extra | quote }}) "Workspace extra")
          ("p" ,(expand-file-name {{ .playground | quote }}) "Playground")
          ("r" ,(expand-file-name {{ .resources | quote }}) "Resources")
          ("s" ,(expand-file-name {{ .managed_sync | quote }}) "Managed Sync")

          ;; Add storage entries
          ("P" ,(expand-file-name {{ .primary_storage | quote }}) "Primary Storage")
          ("S" ,(expand-file-name {{ .secondary_storage | quote }}) "Secondary Storage")))

  (when (executable-find "lla")
    (dirvish-define-preview lla (file)
      "Use `lla' to generate directory preview."
      :require ("lla")
      (when (file-directory-p file)
        `(shell . ("lla" "--icons" ,file))))

    (add-to-list 'dirvish-preview-dispatchers 'lla))

  (defun dirvish-copy-file-relative-path (&optional multi-line)
    "Copy filepath of marked files.
    If MULTI-LINE, make every path occupy a new line."
    (interactive "P")
    (let* ((files (mapcar (lambda (file)
                            (file-relative-name (file-local-name file)))
                          (dired-get-marked-files)))
           (names (mapconcat #'concat files (if multi-line "\n" " "))))
      (dirvish--kill-and-echo (if multi-line (concat "\n" names) names)))))
