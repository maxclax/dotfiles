# -*- mode: nix; -*-
{ pkgs, ... }:

{
  # Zsh Configuration with improvements
  programs.zsh = {
    enable = true;
    enableCompletion = true;
    autosuggestion.enable = true;
    syntaxHighlighting.enable = true;

    # History configuration
    history = {
      size = 10000;
      save = 10000;
      share = true;
      ignoreDups = true;
      ignoreSpace = true;
      expireDuplicatesFirst = true;
    };

{{- if .extraUser }}
    completionInit = "autoload -Uz compinit && compinit -u";
{{- else }}
    completionInit = "autoload -Uz compinit && compinit -C";
{{- end }}

    oh-my-zsh = {
      enable = true;
      theme = "robbyrussell";
{{- if .extraUser }}
      extraConfig = ''
        ZSH_DISABLE_COMPFIX=true
      '';
{{- end }}
      plugins = [
        "brew"
        "git"
        "podman"
        "poetry"
        "kubectl"
        "kubectx"
        "chezmoi"
        "colored-man-pages"  # Colorized man pages
        "command-not-found"  # Suggests packages when command not found
        "sudo"              # Double ESC to add sudo
        "history"           # Better history commands
{{- if eq .chezmoi.os "darwin" }}
        "macos"             # macOS specific commands
{{- end }}
      ];
    };

    shellAliases = {
      # Original aliases
      reload-shell = "source ~/.zshrc";
      edit-zsh = "emacsclient -t ~/.zshrc";
    };

    initContent = ''
      if [[ "$TERM" == "dumb" ]]; then
          PS1='$ '
          return
      fi
      # completion using arrow keys (based on history)
      bindkey '^[[A' history-search-backward
      bindkey '^[[B' history-search-forward

      # Source file if it exists and have a size greater than zero
      [[ -s ~/.config/shell/exports.sh ]] && source ~/.config/shell/exports.sh
      [[ -s ~/.config/shell/aliases.sh ]] && source ~/.config/shell/aliases.sh
      [[ -s ~/.config/shell/sourcing.sh ]] && source ~/.config/shell/sourcing.sh

      # Source additional configurations from .zshrc.local
      if [ -f ~/.zshrc.local ]; then
        source ~/.zshrc.local
      fi
    '';
  };
}
