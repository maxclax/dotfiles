{{ if .borgThisMachine }}
source_directories:
  - {{ .primary_cloud | quote }}

exclude_patterns:
  # System files
  - "*.DS_Store"
  - "*._.DS_Store"
  - ".Spotlight-V100"
  - ".Trashes"
  - ".fseventsd"
  - ".TemporaryItems"
  - ".DocumentRevisions-V100"
  - ".AppleDouble"
  - ".AppleDB"
  - ".AppleDesktop"
  - "Network Trash Folder"
  - "Temporary Items"
  - ".apdisk"
  # Cache and temporary files
  - "*/node_modules"
  - "*/.git"
  - "*/.svn"
  - "*/.hg"
  - "*/target"
  - "*/build"
  - "*/dist"
  - "*/.cache"
  - "*/.tmp"
  - "*/tmp"
  - "*/__pycache__"
  - "*.pyc"
  - "*.pyo"
  - "*.log"
  - "*.swp"
  - "*.swo"
  - "*~"
  - ".#*"
  # Large media files (optional - uncomment if needed)
  # - "*.iso"
  # - "*.dmg"
  # - "*.ova"
  # - "*.vmdk"

local_path: borg
repositories:
  - path: {{ .borgRepo | quote }}

encryption_passcommand: op read "op://Private/chezmoi-data/borg-encryption-passphrase"
compression: "lz4"
archive_name_format: "{hostname}-primary_cloud-{now:%Y-%m-%d-%H%M%S}"

# Retention settings
keep_daily: 7
keep_weekly: 2   
keep_monthly: 3

# Healthchecks
checks:
  - name: repository
    frequency: 2 weeks  # Regular repository checks
  - name: archives
    frequency: 3 days   # More frequent archive checks

# Performance and resource settings
lock_wait: 300  
files_cache: "size,mtime,inode"
read_special: true
one_file_system: false

# Error handling
retries: 3
retry_wait: 60

{{ if .borgWithPushover }}
pushover:
    token: {{ onepasswordRead "op://Private/chezmoi-data/pushover-token" }}
    user: {{ onepasswordRead "op://Private/chezmoi-data/pushover-user-key" }}
    start: 
        title: "üîÑ Borg Backup Started: primary_cloud"
        message: "Starting backup on {{ .hostname }}"
        priority: -1
        html: True
        ttl: 30
    fail: 
        title: "‚ùå Borg Backup Failed: primary_cloud"
        message: "Backup failed on {{ .hostname }}. Check logs for details."
        priority: 2
        html: True
        sound: "siren"
        expire: 3600
        retry: 60
    finish: 
        title: "‚úÖ Borg Backup Complete: primary_cloud"
        message: "Successfully backed up on {{ .hostname }}"
        priority: 0
        html: True
        ttl: 3600
    states: 
        #- start 
        - finish 
        - fail
{{ end }}
{{ end }}
