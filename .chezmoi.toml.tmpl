{{- $workspace := promptStringOnce . "workspace" "workspace directory" (printf "%s/workspace" .chezmoi.homeDir) -}}

{{- $nvimType := "default" -}}
{{- if stdinIsATTY -}}
  {{- $choices := list "default" "nvim-custom" "kickstart.nvim" "kickstart-modular.nvim" "LunarVim" "LazyVim" "NvChad" "AstroNvim" "NormalNvim" "neovim-for-newbs" -}}
  {{- $nvimType = promptChoiceOnce . "nvimType" "What type of NeoVim are you on" $choices -}}
{{- end -}}

{{- $emacsType := "default" -}}
{{- if stdinIsATTY -}}
  {{- $choices := list "default" "Doom" "Spacemacs" -}}
  {{- $emacsType = promptChoiceOnce . "emacsType" "What type of Emacs are you on" $choices -}}
{{- end -}}

{{/* boolean feature tags */}}
{{- $ephemeral := false -}}{{/* true if this machine is ephemeral, e.g. a cloud, VM instance or for short time */}}
{{- $headless := false -}}{{/* true if this machine does not have a screen and keyboard */}}
{{- $personal :=  false -}}{{/* true if this machine should have personal secrets */}}
{{- "" -}}

{{- $osID := .chezmoi.os -}}
{{- if (and (eq .chezmoi.os "linux") (hasKey .chezmoi.osRelease "id")) -}}
{{-   $osID = printf "%s-%s" .chezmoi.os .chezmoi.osRelease.id -}}
{{- end -}}

{{/* detect GitHub codespaces, VSCode remote containers, Docker containers, Multipass VMs, and Vagrant boxes */}}
{{- if or (env "CODESPACES") (env "REMOTE_CONTAINERS_IPC") (eq .chezmoi.username "root" "ubuntu" "vagrant" "vscode") -}}
{{-   $ephemeral = true -}}
{{-   $headless = true -}}
{{- end -}}

{{- if eq .chezmoi.os "windows" -}}
{{-   $ephemeral = true -}}
{{- end -}}

{{- $hostname := .chezmoi.hostname -}}
{{- if not $ephemeral -}}
{{-   if or (eq $hostname "space") (contains "space-" $hostname) -}}
{{-     $personal = true -}}
{{-   else if or (eq $hostname "debian") (eq $hostname "ubuntu") (eq $hostname "centos") -}}
{{-     $headless = true -}}
{{-     $personal = true -}}
{{-   else if stdinIsATTY -}}
{{-     $headless = promptBoolOnce . "headless" "Is this machine headless? Has a screen and keyboard?" false -}}
{{-     $ephemeral = promptBoolOnce . "ephemeral" "Is this machine ephemeral? Cloud, VM instance or for short time?" false -}}
{{-   else -}}
{{-     $ephemeral = true -}}
{{-     $headless = true -}}
{{-   end -}}
{{- end -}}

{{- $name := "dev" -}}
{{- $email := "dev" -}}
{{- $githubName := "dev" -}} 
{{- $githubEmail := "dev" -}}
{{- $githubGpgsignEnabled := false -}}
{{- $githubGpgsignSigningKey := "" -}}
{{- $githubGpgsignProgram := "" -}}
{{- $agePubKey := "" -}}
{{- $borgEncryptionPassphrase := "" -}}

{{- $useOp := promptBoolOnce . "useOp" "Do you want to use 1Password CLI (op) for configuration?" true -}}

{{- if $useOp -}}
{{-   $githubGpgsignEnabled = promptBoolOnce . "gitGpgSign" "Enable GPG signing for Git commits?" false  -}}
{{-   $agePubKey = onepasswordRead "op://Private/chezmoi-data/age-pub-key" | quote -}}
{{-   $borgEncryptionPassphrase = onepasswordRead "op://Private/chezmoi-data/borg-encryption-passphrase" | quote -}}
{{-   $name = onepasswordRead "op://Private/chezmoi-data/git-config-name" | quote -}}
{{-   $email = onepasswordRead "op://Private/chezmoi-data/git-config-email" | quote -}}
{{-   $githubName = onepasswordRead "op://Private/chezmoi-data/github-username" | quote -}}
{{-   $githubEmail = onepasswordRead "op://Private/chezmoi-data/github-email"  | quote -}}
{{-   $githubGpgsignSigningKey = onepasswordRead "op://Private/chezmoi-data/github-signing-key" | quote -}}
{{-   $githubGpgsignProgram = promptStringOnce . "gitGpgSignProgram" "GPG signing program" "/Applications/1Password.app/Contents/MacOS/op-ssh-sign" | quote -}}
{{- end -}}


encryption = "age"
[age]
    identity = {{ promptStringOnce . "identity" "Age identity file location" (printf "%s/.config/chezmoi/key.txt" .chezmoi.homeDir) | quote }}
    recipient = {{ $agePubKey }}

[onepassword]
    command = "op"
    prompt = false

[data]
    nvimType = {{ $nvimType | quote }}
    emacsType = {{ $emacsType | quote }}
    ephemeral = {{ $ephemeral }}
    headless = {{ $headless }}
    hostname = {{ $hostname | quote }}
    personal = {{ $personal }}
    osid = {{ $osID | quote }}
    unameArch = {{ output "uname" "-m" | trim | quote }}
    workspace = {{ $workspace | quote }}
    playground = {{ printf "%s/playground" $workspace | quote }}
    jupyter = {{ printf "%s/jupyter" $workspace | quote }}
    borgEncryptionPassphrase = {{ $borgEncryptionPassphrase }}
    borgRepository = {{ promptStringOnce . "borgRepository" "Borg repository location" (printf "%s/.backup_repo.borg" .chezmoi.homeDir) | quote }}

[data.fonts]
    enabled = {{ promptBoolOnce . "fontsEnabled" "Enable FONTS installation?" false }}
    path = {{ printf "%s/fonts" $workspace | quote }}

[data.nvim]
    loadAllDistros = {{ promptBoolOnce . "nvimLoadAllDistros" "Load all NeoVim distributions?" true }}

[data.podman]
    enabled = {{ promptBoolOnce . "podmanEnabled" "Enable Podman container engine?" true }}

[data.docker]
    enabled = {{ promptBoolOnce . "dockerEnabled" "Enable Docker container engine?" false }}

[data.container]
    engine = {{ promptStringOnce . "containerEngine" "Container engine to use (podman or docker)" "podman" | quote }}

[data.obsidian]
    vault = {{ promptStringOnce . "obsidianVault" "Obsidian vault location" "~/Library/Mobile Documents/iCloud~md~obsidian/Documents/" | quote }}

[data.go]
    enabled = {{ promptBoolOnce . "goEnabled" "Enable Go development environment?" false }}
    
[data.rust]
    enabled = {{ promptBoolOnce . "rustEnabled" "Enable Rust development environment?" false }}

[data.python]
    enabled = {{ promptBoolOnce . "pythonEnabled" "Enable Python development environment?" false }}
    version = {{ promptStringOnce . "pythonVersion" "Python version" "3.13.1" | quote}}
    dependencies = [
        "pikepdf = \"*\"",
        "ffmpeg-python = \"*\"",
        "pillow = \"*\""
    ]

[data.git]
    name = {{ $name }} 
    email = {{ $email }} 
    localRepositories = {{ printf "%s/.local/git" .chezmoi.destDir | quote }}
    github.name = {{ $githubName }}
    github.email = {{ $githubEmail }}
    github.gpgsign.enabled = {{ $githubGpgsignEnabled }}
    github.gpgsign.signingKey = {{ $githubGpgsignSigningKey }}
    github.gpgsign.program = {{ $githubGpgsignProgram  }}

[data.ollama]
    pidFile = {{ promptStringOnce . "ollamaPidFile" "Ollama PID file location" "/tmp/ollama.pid" | quote }}
    port = {{ promptIntOnce . "ollamaPort" "Ollama API port" 11434 }}
    model = {{ promptStringOnce . "ollamaModel" "Ollama model to use" "llama3.2:latest" | quote }}

[data.torproxy]
    host = {{ promptStringOnce . "torproxyHost" "Tor proxy host" "localhost" | quote }}
    portSocks5 = {{ promptIntOnce . "torproxyPortSocks5" "Tor proxy SOCKS5 port" 9150 }}
    portDns = {{ promptIntOnce . "torproxyPortDns" "Tor proxy DNS port" 8893 }}

[git]
  autoCommit = {{ promptBoolOnce . "gitAutoCommit" "Enable automatic commits?" false }}
  autoPush = {{ promptBoolOnce . "gitAutoPush" "Enable automatic push?" false }}
